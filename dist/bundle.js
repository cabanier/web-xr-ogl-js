/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var t={};function e(t){let e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function r(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function i(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function s(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function a(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function n(t){let e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function o(t,e){let r=e[0],i=e[1],s=e[2],a=r*r+i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}function h(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function l(t,e,r){let i=e[0],s=e[1],a=e[2],n=r[0],o=r[1],h=r[2];return t[0]=s*h-a*o,t[1]=a*n-i*h,t[2]=i*o-s*n,t}t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();const u=function(){const t=[0,0,0],e=[0,0,0];return function(i,s){r(t,i),r(e,s),o(t,t),o(e,e);let a=h(t,e);return a>1?0:a<-1?Math.PI:Math.acos(a)}}();class c extends Array{constructor(t=0,e=t,r=t){return super(t,e,r),this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set(t,e=t,r=t){return t.length?this.copy(t):(function(t,e,r,i){t[0]=e,t[1]=r,t[2]=i}(this,t,e,r),this)}copy(t){return r(this,t),this}add(t,e){return e?i(this,t,e):i(this,this,t),this}sub(t,e){return e?s(this,t,e):s(this,this,t),this}multiply(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]*i[0],e[1]=r[1]*i[1],e[2]=r[2]*i[2]):a(this,this,t),this}divide(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]/i[0],e[1]=r[1]/i[1],e[2]=r[2]/i[2]):a(this,this,1/t),this}inverse(t=this){var e,r;return r=t,(e=this)[0]=1/r[0],e[1]=1/r[1],e[2]=1/r[2],this}len(){return e(this)}distance(t){return t?function(t,e){let r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(r*r+i*i+s*s)}(this,t):e(this)}squaredLen(){return n(this)}squaredDistance(t){return t?function(t,e){let r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}(this,t):n(this)}negate(t=this){var e,r;return r=t,(e=this)[0]=-r[0],e[1]=-r[1],e[2]=-r[2],this}cross(t,e){return e?l(this,t,e):l(this,this,t),this}scale(t){return a(this,this,t),this}normalize(){return o(this,this),this}dot(t){return h(this,t)}equals(t){return e=t,this[0]===e[0]&&this[1]===e[1]&&this[2]===e[2];var e}applyMatrix4(t){return function(t,e,r){let i=e[0],s=e[1],a=e[2],n=r[3]*i+r[7]*s+r[11]*a+r[15];n=n||1,t[0]=(r[0]*i+r[4]*s+r[8]*a+r[12])/n,t[1]=(r[1]*i+r[5]*s+r[9]*a+r[13])/n,t[2]=(r[2]*i+r[6]*s+r[10]*a+r[14])/n}(this,this,t),this}scaleRotateMatrix4(t){return function(t,e,r){let i=e[0],s=e[1],a=e[2],n=r[3]*i+r[7]*s+r[11]*a+r[15];n=n||1,t[0]=(r[0]*i+r[4]*s+r[8]*a)/n,t[1]=(r[1]*i+r[5]*s+r[9]*a)/n,t[2]=(r[2]*i+r[6]*s+r[10]*a)/n}(this,this,t),this}applyQuaternion(t){return function(t,e,r){let i=e[0],s=e[1],a=e[2],n=r[0],o=r[1],h=r[2],l=o*a-h*s,u=h*i-n*a,c=n*s-o*i,d=o*c-h*u,x=h*l-n*c,g=n*u-o*l,p=2*r[3];l*=p,u*=p,c*=p,d*=2,x*=2,g*=2,t[0]=i+l+d,t[1]=s+u+x,t[2]=a+c+g}(this,this,t),this}angle(t){return u(this,t)}lerp(t,e){return function(t,e,r,i){let s=e[0],a=e[1],n=e[2];t[0]=s+i*(r[0]-s),t[1]=a+i*(r[1]-a),t[2]=n+i*(r[2]-n)}(this,this,t,e),this}clone(){return new c(this[0],this[1],this[2])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}transformDirection(t){const e=this[0],r=this[1],i=this[2];return this[0]=t[0]*e+t[4]*r+t[8]*i,this[1]=t[1]*e+t[5]*r+t[9]*i,this[2]=t[2]*e+t[6]*r+t[10]*i,this.normalize()}}function d(t,e,r){let i=e[0],s=e[1],a=e[2],n=e[3],o=r[0],h=r[1],l=r[2],u=r[3];return t[0]=i*u+n*o+s*l-a*h,t[1]=s*u+n*h+a*o-i*l,t[2]=a*u+n*l+i*h-s*o,t[3]=n*u-i*o-s*h-a*l,t}class x extends Array{constructor(t=0,e=0,r=0,i=1){return super(t,e,r,i),this.onChange=()=>{},this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(t){this[0]=t,this.onChange()}set y(t){this[1]=t,this.onChange()}set z(t){this[2]=t,this.onChange()}set w(t){this[3]=t,this.onChange()}identity(){var t;return(t=this)[0]=0,t[1]=0,t[2]=0,t[3]=1,this.onChange(),this}set(t,e,r,i){return t.length?this.copy(t):(function(t,e,r,i,s){t[0]=e,t[1]=r,t[2]=i,t[3]=s}(this,t,e,r,i),this.onChange(),this)}rotateX(t){return function(t,e,r){r*=.5;let i=e[0],s=e[1],a=e[2],n=e[3],o=Math.sin(r),h=Math.cos(r);t[0]=i*h+n*o,t[1]=s*h+a*o,t[2]=a*h-s*o,t[3]=n*h-i*o}(this,this,t),this.onChange(),this}rotateY(t){return function(t,e,r){r*=.5;let i=e[0],s=e[1],a=e[2],n=e[3],o=Math.sin(r),h=Math.cos(r);t[0]=i*h-a*o,t[1]=s*h+n*o,t[2]=a*h+i*o,t[3]=n*h-s*o}(this,this,t),this.onChange(),this}rotateZ(t){return function(t,e,r){r*=.5;let i=e[0],s=e[1],a=e[2],n=e[3],o=Math.sin(r),h=Math.cos(r);t[0]=i*h+s*o,t[1]=s*h-i*o,t[2]=a*h+n*o,t[3]=n*h-a*o}(this,this,t),this.onChange(),this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=r*r+i*i+s*s+a*a,o=n?1/n:0;t[0]=-r*o,t[1]=-i*o,t[2]=-s*o,t[3]=a*o}(this,t),this.onChange(),this}conjugate(t=this){var e,r;return r=t,(e=this)[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=r[3],this.onChange(),this}copy(t){return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],this.onChange(),this;var e,r}normalize(t=this){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=r*r+i*i+s*s+a*a;n>0&&(n=1/Math.sqrt(n)),t[0]=r*n,t[1]=i*n,t[2]=s*n,t[3]=a*n}(this,t),this.onChange(),this}multiply(t,e){return e?d(this,t,e):d(this,this,t),this.onChange(),this}dot(t){return r=t,(e=this)[0]*r[0]+e[1]*r[1]+e[2]*r[2]+e[3]*r[3];var e,r}fromMatrix3(t){return function(t,e){let r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);let s=(i+1)%3,a=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*a+a]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*s+a]-e[3*a+s])*r,t[s]=(e[3*s+i]+e[3*i+s])*r,t[a]=(e[3*a+i]+e[3*i+a])*r}}(this,t),this.onChange(),this}fromEuler(t){return function(t,e,r="YXZ"){let i=Math.sin(.5*e[0]),s=Math.cos(.5*e[0]),a=Math.sin(.5*e[1]),n=Math.cos(.5*e[1]),o=Math.sin(.5*e[2]),h=Math.cos(.5*e[2]);"XYZ"===r?(t[0]=i*n*h+s*a*o,t[1]=s*a*h-i*n*o,t[2]=s*n*o+i*a*h,t[3]=s*n*h-i*a*o):"YXZ"===r?(t[0]=i*n*h+s*a*o,t[1]=s*a*h-i*n*o,t[2]=s*n*o-i*a*h,t[3]=s*n*h+i*a*o):"ZXY"===r?(t[0]=i*n*h-s*a*o,t[1]=s*a*h+i*n*o,t[2]=s*n*o+i*a*h,t[3]=s*n*h-i*a*o):"ZYX"===r?(t[0]=i*n*h-s*a*o,t[1]=s*a*h+i*n*o,t[2]=s*n*o-i*a*h,t[3]=s*n*h+i*a*o):"YZX"===r?(t[0]=i*n*h+s*a*o,t[1]=s*a*h+i*n*o,t[2]=s*n*o-i*a*h,t[3]=s*n*h-i*a*o):"XZY"===r&&(t[0]=i*n*h-s*a*o,t[1]=s*a*h-i*n*o,t[2]=s*n*o+i*a*h,t[3]=s*n*h+i*a*o)}(this,t,t.order),this}fromAxisAngle(t,e){return function(t,e,r){r*=.5;let i=Math.sin(r);t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r)}(this,t,e),this}slerp(t,e){return function(t,e,r,i){let s,a,n,o,h,l=e[0],u=e[1],c=e[2],d=e[3],x=r[0],g=r[1],p=r[2],f=r[3];a=l*x+u*g+c*p+d*f,a<0&&(a=-a,x=-x,g=-g,p=-p,f=-f),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),o=Math.sin((1-i)*s)/n,h=Math.sin(i*s)/n):(o=1-i,h=i),t[0]=o*l+h*x,t[1]=o*u+h*g,t[2]=o*c+h*p,t[3]=o*d+h*f}(this,this,t,e),this}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}function g(t,e,r){let i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],x=e[10],g=e[11],p=e[12],f=e[13],m=e[14],y=e[15],T=r[0],_=r[1],w=r[2],E=r[3];return t[0]=T*i+_*o+w*c+E*p,t[1]=T*s+_*h+w*d+E*f,t[2]=T*a+_*l+w*x+E*m,t[3]=T*n+_*u+w*g+E*y,T=r[4],_=r[5],w=r[6],E=r[7],t[4]=T*i+_*o+w*c+E*p,t[5]=T*s+_*h+w*d+E*f,t[6]=T*a+_*l+w*x+E*m,t[7]=T*n+_*u+w*g+E*y,T=r[8],_=r[9],w=r[10],E=r[11],t[8]=T*i+_*o+w*c+E*p,t[9]=T*s+_*h+w*d+E*f,t[10]=T*a+_*l+w*x+E*m,t[11]=T*n+_*u+w*g+E*y,T=r[12],_=r[13],w=r[14],E=r[15],t[12]=T*i+_*o+w*c+E*p,t[13]=T*s+_*h+w*d+E*f,t[14]=T*a+_*l+w*x+E*m,t[15]=T*n+_*u+w*g+E*y,t}function p(t,e){let r=e[0],i=e[1],s=e[2],a=e[4],n=e[5],o=e[6],h=e[8],l=e[9],u=e[10];return t[0]=Math.hypot(r,i,s),t[1]=Math.hypot(a,n,o),t[2]=Math.hypot(h,l,u),t}const f=function(){const t=[0,0,0];return function(e,r){let i=t;p(i,r);let s=1/i[0],a=1/i[1],n=1/i[2],o=r[0]*s,h=r[1]*a,l=r[2]*n,u=r[4]*s,c=r[5]*a,d=r[6]*n,x=r[8]*s,g=r[9]*a,f=r[10]*n,m=o+c+f,y=0;return m>0?(y=2*Math.sqrt(m+1),e[3]=.25*y,e[0]=(d-g)/y,e[1]=(x-l)/y,e[2]=(h-u)/y):o>c&&o>f?(y=2*Math.sqrt(1+o-c-f),e[3]=(d-g)/y,e[0]=.25*y,e[1]=(h+u)/y,e[2]=(x+l)/y):c>f?(y=2*Math.sqrt(1+c-o-f),e[3]=(x-l)/y,e[0]=(h+u)/y,e[1]=.25*y,e[2]=(d+g)/y):(y=2*Math.sqrt(1+f-o-c),e[3]=(h-u)/y,e[0]=(x+l)/y,e[1]=(d+g)/y,e[2]=.25*y),e}}();class m extends Array{constructor(t=1,e=0,r=0,i=0,s=0,a=1,n=0,o=0,h=0,l=0,u=1,c=0,d=0,x=0,g=0,p=1){return super(t,e,r,i,s,a,n,o,h,l,u,c,d,x,g,p),this}get x(){return this[12]}get y(){return this[13]}get z(){return this[14]}get w(){return this[15]}set x(t){this[12]=t}set y(t){this[13]=t}set z(t){this[14]=t}set w(t){this[15]=t}set(t,e,r,i,s,a,n,o,h,l,u,c,d,x,g,p){return t.length?this.copy(t):(function(t,e,r,i,s,a,n,o,h,l,u,c,d,x,g,p,f){t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=a,t[5]=n,t[6]=o,t[7]=h,t[8]=l,t[9]=u,t[10]=c,t[11]=d,t[12]=x,t[13]=g,t[14]=p,t[15]=f}(this,t,e,r,i,s,a,n,o,h,l,u,c,d,x,g,p),this)}translate(t,e=this){return function(t,e,r){let i,s,a,n,o,h,l,u,c,d,x,g,p=r[0],f=r[1],m=r[2];e===t?(t[12]=e[0]*p+e[4]*f+e[8]*m+e[12],t[13]=e[1]*p+e[5]*f+e[9]*m+e[13],t[14]=e[2]*p+e[6]*f+e[10]*m+e[14],t[15]=e[3]*p+e[7]*f+e[11]*m+e[15]):(i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],x=e[10],g=e[11],t[0]=i,t[1]=s,t[2]=a,t[3]=n,t[4]=o,t[5]=h,t[6]=l,t[7]=u,t[8]=c,t[9]=d,t[10]=x,t[11]=g,t[12]=i*p+o*f+c*m+e[12],t[13]=s*p+h*f+d*m+e[13],t[14]=a*p+l*f+x*m+e[14],t[15]=n*p+u*f+g*m+e[15])}(this,e,t),this}rotate(t,e,r=this){return function(t,e,r,i){let s,a,n,o,h,l,u,c,d,x,g,p,f,m,y,T,_,w,E,b,v,A,R,M,S=i[0],P=i[1],F=i[2],L=Math.hypot(S,P,F);Math.abs(L)<1e-6||(L=1/L,S*=L,P*=L,F*=L,s=Math.sin(r),a=Math.cos(r),n=1-a,o=e[0],h=e[1],l=e[2],u=e[3],c=e[4],d=e[5],x=e[6],g=e[7],p=e[8],f=e[9],m=e[10],y=e[11],T=S*S*n+a,_=P*S*n+F*s,w=F*S*n-P*s,E=S*P*n-F*s,b=P*P*n+a,v=F*P*n+S*s,A=S*F*n+P*s,R=P*F*n-S*s,M=F*F*n+a,t[0]=o*T+c*_+p*w,t[1]=h*T+d*_+f*w,t[2]=l*T+x*_+m*w,t[3]=u*T+g*_+y*w,t[4]=o*E+c*b+p*v,t[5]=h*E+d*b+f*v,t[6]=l*E+x*b+m*v,t[7]=u*E+g*b+y*v,t[8]=o*A+c*R+p*M,t[9]=h*A+d*R+f*M,t[10]=l*A+x*R+m*M,t[11]=u*A+g*R+y*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this,r,t,e),this}scale(t,e=this){return function(t,e,r){let i=r[0],s=r[1],a=r[2];t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*a,t[9]=e[9]*a,t[10]=e[10]*a,t[11]=e[11]*a,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this,e,"number"==typeof t?[t,t,t]:t),this}multiply(t,e){return e?g(this,t,e):g(this,this,t),this}identity(){var t;return(t=this)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}copy(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}fromPerspective({fov:t,aspect:e,near:r,far:i}={}){return function(t,e,r,i,s){let a=1/Math.tan(e/2),n=1/(i-s);t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(s+i)*n,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*s*i*n,t[15]=0}(this,t,e,r,i),this}fromOrthogonal({left:t,right:e,bottom:r,top:i,near:s,far:a}){return function(t,e,r,i,s,a,n){let o=1/(e-r),h=1/(i-s),l=1/(a-n);t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+r)*o,t[13]=(s+i)*h,t[14]=(n+a)*l,t[15]=1}(this,t,e,r,i,s,a),this}fromQuaternion(t){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=r+r,o=i+i,h=s+s,l=r*n,u=i*n,c=i*o,d=s*n,x=s*o,g=s*h,p=a*n,f=a*o,m=a*h;t[0]=1-c-g,t[1]=u+m,t[2]=d-f,t[3]=0,t[4]=u-m,t[5]=1-l-g,t[6]=x+p,t[7]=0,t[8]=d+f,t[9]=x-p,t[10]=1-l-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this,t),this}setPosition(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=e[9],d=e[10],x=e[11],g=e[12],p=e[13],f=e[14],m=e[15],y=r*o-i*n,T=r*h-s*n,_=r*l-a*n,w=i*h-s*o,E=i*l-a*o,b=s*l-a*h,v=u*p-c*g,A=u*f-d*g,R=u*m-x*g,M=c*f-d*p,S=c*m-x*p,P=d*m-x*f,F=y*P-T*S+_*M+w*R-E*A+b*v;F&&(F=1/F,t[0]=(o*P-h*S+l*M)*F,t[1]=(s*S-i*P-a*M)*F,t[2]=(p*b-f*E+m*w)*F,t[3]=(d*E-c*b-x*w)*F,t[4]=(h*R-n*P-l*A)*F,t[5]=(r*P-s*R+a*A)*F,t[6]=(f*_-g*b-m*T)*F,t[7]=(u*b-d*_+x*T)*F,t[8]=(n*S-o*R+l*v)*F,t[9]=(i*R-r*S-a*v)*F,t[10]=(g*E-p*_+m*y)*F,t[11]=(c*_-u*E-x*y)*F,t[12]=(o*A-n*M-h*v)*F,t[13]=(r*M-i*A+s*v)*F,t[14]=(p*T-g*w-f*y)*F,t[15]=(u*w-c*T+d*y)*F)}(this,t),this}compose(t,e,r){return function(t,e,r,i){let s=e[0],a=e[1],n=e[2],o=e[3],h=s+s,l=a+a,u=n+n,c=s*h,d=s*l,x=s*u,g=a*l,p=a*u,f=n*u,m=o*h,y=o*l,T=o*u,_=i[0],w=i[1],E=i[2];t[0]=(1-(g+f))*_,t[1]=(d+T)*_,t[2]=(x-y)*_,t[3]=0,t[4]=(d-T)*w,t[5]=(1-(c+f))*w,t[6]=(p+m)*w,t[7]=0,t[8]=(x+y)*E,t[9]=(p-m)*E,t[10]=(1-(c+g))*E,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1}(this,t,e,r),this}getRotation(t){return f(t,this),this}getTranslation(t){var e,r;return r=this,(e=t)[0]=r[12],e[1]=r[13],e[2]=r[14],this}getScaling(t){return p(t,this),this}getMaxScaleOnAxis(){return function(t){let e=t[0],r=t[1],i=t[2],s=t[4],a=t[5],n=t[6],o=t[8],h=t[9],l=t[10];const u=e*e+r*r+i*i,c=s*s+a*a+n*n,d=o*o+h*h+l*l;return Math.sqrt(Math.max(u,c,d))}(this)}lookAt(t,e,r){return function(t,e,r,i){let s=e[0],a=e[1],n=e[2],o=i[0],h=i[1],l=i[2],u=s-r[0],c=a-r[1],d=n-r[2],x=u*u+c*c+d*d;0===x?d=1:(x=1/Math.sqrt(x),u*=x,c*=x,d*=x);let g=h*d-l*c,p=l*u-o*d,f=o*c-h*u;x=g*g+p*p+f*f,0===x&&(l?o+=1e-6:h?l+=1e-6:h+=1e-6,g=h*d-l*c,p=l*u-o*d,f=o*c-h*u,x=g*g+p*p+f*f),x=1/Math.sqrt(x),g*=x,p*=x,f*=x,t[0]=g,t[1]=p,t[2]=f,t[3]=0,t[4]=c*f-d*p,t[5]=d*g-u*f,t[6]=u*p-c*g,t[7]=0,t[8]=u,t[9]=c,t[10]=d,t[11]=0,t[12]=s,t[13]=a,t[14]=n,t[15]=1}(this,t,e,r),this}determinant(){return function(t){let e=t[0],r=t[1],i=t[2],s=t[3],a=t[4],n=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],d=t[11],x=t[12],g=t[13],p=t[14],f=t[15];return(e*n-r*a)*(c*f-d*p)-(e*o-i*a)*(u*f-d*g)+(e*h-s*a)*(u*p-c*g)+(r*o-i*n)*(l*f-d*x)-(r*h-s*n)*(l*p-c*x)+(i*h-s*o)*(l*g-u*x)}(this)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this[4]=t[e+4],this[5]=t[e+5],this[6]=t[e+6],this[7]=t[e+7],this[8]=t[e+8],this[9]=t[e+9],this[10]=t[e+10],this[11]=t[e+11],this[12]=t[e+12],this[13]=t[e+13],this[14]=t[e+14],this[15]=t[e+15],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t[e+4]=this[4],t[e+5]=this[5],t[e+6]=this[6],t[e+7]=this[7],t[e+8]=this[8],t[e+9]=this[9],t[e+10]=this[10],t[e+11]=this[11],t[e+12]=this[12],t[e+13]=this[13],t[e+14]=this[14],t[e+15]=this[15],t}}const y=new m;class T extends Array{constructor(t=0,e=t,r=t,i="YXZ"){return super(t,e,r),this.order=i,this.onChange=()=>{},this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t,this.onChange()}set y(t){this[1]=t,this.onChange()}set z(t){this[2]=t,this.onChange()}set(t,e=t,r=t){return t.length?this.copy(t):(this[0]=t,this[1]=e,this[2]=r,this.onChange(),this)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.onChange(),this}reorder(t){return this.order=t,this.onChange(),this}fromRotationMatrix(t,e=this.order){return function(t,e,r="YXZ"){"XYZ"===r?(t[1]=Math.asin(Math.min(Math.max(e[8],-1),1)),Math.abs(e[8])<.99999?(t[0]=Math.atan2(-e[9],e[10]),t[2]=Math.atan2(-e[4],e[0])):(t[0]=Math.atan2(e[6],e[5]),t[2]=0)):"YXZ"===r?(t[0]=Math.asin(-Math.min(Math.max(e[9],-1),1)),Math.abs(e[9])<.99999?(t[1]=Math.atan2(e[8],e[10]),t[2]=Math.atan2(e[1],e[5])):(t[1]=Math.atan2(-e[2],e[0]),t[2]=0)):"ZXY"===r?(t[0]=Math.asin(Math.min(Math.max(e[6],-1),1)),Math.abs(e[6])<.99999?(t[1]=Math.atan2(-e[2],e[10]),t[2]=Math.atan2(-e[4],e[5])):(t[1]=0,t[2]=Math.atan2(e[1],e[0]))):"ZYX"===r?(t[1]=Math.asin(-Math.min(Math.max(e[2],-1),1)),Math.abs(e[2])<.99999?(t[0]=Math.atan2(e[6],e[10]),t[2]=Math.atan2(e[1],e[0])):(t[0]=0,t[2]=Math.atan2(-e[4],e[5]))):"YZX"===r?(t[2]=Math.asin(Math.min(Math.max(e[1],-1),1)),Math.abs(e[1])<.99999?(t[0]=Math.atan2(-e[9],e[5]),t[1]=Math.atan2(-e[2],e[0])):(t[0]=0,t[1]=Math.atan2(e[8],e[10]))):"XZY"===r&&(t[2]=Math.asin(-Math.min(Math.max(e[4],-1),1)),Math.abs(e[4])<.99999?(t[0]=Math.atan2(e[6],e[5]),t[1]=Math.atan2(e[8],e[0])):(t[0]=Math.atan2(-e[9],e[10]),t[1]=0))}(this,t,e),this}fromQuaternion(t,e=this.order){return y.fromQuaternion(t),this.fromRotationMatrix(y,e)}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}}class _{constructor(){this.parent=null,this.children=[],this.visible=!0,this.matrix=new m,this.worldMatrix=new m,this.matrixAutoUpdate=!0,this.position=new c,this.quaternion=new x,this.scale=new c(1),this.rotation=new T,this.up=new c(0,1,0),this.rotation.onChange=()=>this.quaternion.fromEuler(this.rotation),this.quaternion.onChange=()=>this.rotation.fromQuaternion(this.quaternion)}setParent(t,e=!0){this.parent&&t!==this.parent&&this.parent.removeChild(this,!1),this.parent=t,e&&t&&t.addChild(this,!1)}addChild(t,e=!0){~this.children.indexOf(t)||this.children.push(t),e&&t.setParent(this,!1)}removeChild(t,e=!0){~this.children.indexOf(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||t)&&(null===this.parent?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,t=!0);for(let e=0,r=this.children.length;e<r;e++)this.children[e].updateMatrixWorld(t)}updateMatrix(){this.matrix.compose(this.quaternion,this.position,this.scale),this.worldMatrixNeedsUpdate=!0}traverse(t){if(!t(this))for(let e=0,r=this.children.length;e<r;e++)this.children[e].traverse(t)}decompose(){this.matrix.getTranslation(this.position),this.matrix.getRotation(this.quaternion),this.matrix.getScaling(this.scale),this.rotation.fromQuaternion(this.quaternion)}lookAt(t,e=!1){e?this.matrix.lookAt(this.position,t,this.up):this.matrix.lookAt(t,this.position,this.up),this.matrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}}const w=new m,E=new c,b=new c;class v extends _{constructor(t,{near:e=.1,far:r=100,fov:i=45,aspect:s=1,left:a,right:n,bottom:o,top:h,zoom:l=1}={}){super(),Object.assign(this,{near:e,far:r,fov:i,aspect:s,left:a,right:n,bottom:o,top:h,zoom:l}),this.projectionMatrix=new m,this.viewMatrix=new m,this.projectionViewMatrix=new m,this.worldPosition=new c,this.type=a||n?"orthographic":"perspective","orthographic"===this.type?this.orthographic():this.perspective()}perspective({near:t=this.near,far:e=this.far,fov:r=this.fov,aspect:i=this.aspect}={}){return Object.assign(this,{near:t,far:e,fov:r,aspect:i}),this.projectionMatrix.fromPerspective({fov:r*(Math.PI/180),aspect:i,near:t,far:e}),this.type="perspective",this}orthographic({near:t=this.near,far:e=this.far,left:r=this.left,right:i=this.right,bottom:s=this.bottom,top:a=this.top,zoom:n=this.zoom}={}){return Object.assign(this,{near:t,far:e,left:r,right:i,bottom:s,top:a,zoom:n}),r/=n,i/=n,s/=n,a/=n,this.projectionMatrix.fromOrthogonal({left:r,right:i,bottom:s,top:a,near:t,far:e}),this.type="orthographic",this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.inverse(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}lookAt(t){return super.lookAt(t,!0),this}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(w.inverse(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateFrustum(){this.frustum||(this.frustum=[new c,new c,new c,new c,new c,new c]);const t=this.projectionViewMatrix;this.frustum[0].set(t[3]-t[0],t[7]-t[4],t[11]-t[8]).constant=t[15]-t[12],this.frustum[1].set(t[3]+t[0],t[7]+t[4],t[11]+t[8]).constant=t[15]+t[12],this.frustum[2].set(t[3]+t[1],t[7]+t[5],t[11]+t[9]).constant=t[15]+t[13],this.frustum[3].set(t[3]-t[1],t[7]-t[5],t[11]-t[9]).constant=t[15]-t[13],this.frustum[4].set(t[3]-t[2],t[7]-t[6],t[11]-t[10]).constant=t[15]-t[14],this.frustum[5].set(t[3]+t[2],t[7]+t[6],t[11]+t[10]).constant=t[15]+t[14];for(let t=0;t<6;t++){const e=1/this.frustum[t].distance();this.frustum[t].multiply(e),this.frustum[t].constant*=e}}frustumIntersectsMesh(t){if(!t.geometry.attributes.position)return!0;if(t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere(),!t.geometry.bounds)return!0;const e=E;e.copy(t.geometry.bounds.center),e.applyMatrix4(t.worldMatrix);const r=t.geometry.bounds.radius*t.worldMatrix.getMaxScaleOnAxis();return this.frustumIntersectsSphere(e,r)}frustumIntersectsSphere(t,e){const r=b;for(let i=0;i<6;i++){const s=this.frustum[i];if(r.copy(s).dot(t)+s.constant<-e)return!1}return!0}}const A=new c;let R=1,M=1,S=!1;class P{constructor(t,e={}){t.canvas||console.error("gl not passed as first argument to Geometry"),this.gl=t,this.attributes=e,this.id=R++,this.VAOs={},this.drawRange={start:0,count:0},this.instancedCount=0,this.gl.renderer.bindVertexArray(null),this.gl.renderer.currentGeometry=null,this.glState=this.gl.renderer.state;for(let t in e)this.addAttribute(t,e[t])}addAttribute(t,e){if(this.attributes[t]=e,e.id=M++,e.size=e.size||1,e.type=e.type||(e.data.constructor===Float32Array?this.gl.FLOAT:e.data.constructor===Uint16Array?this.gl.UNSIGNED_SHORT:this.gl.UNSIGNED_INT),e.target="index"===t?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER,e.normalized=e.normalized||!1,e.stride=e.stride||0,e.offset=e.offset||0,e.count=e.count||(e.stride?e.data.byteLength/e.stride:e.data.length/e.size),e.divisor=e.instanced||0,e.needsUpdate=!1,e.buffer||(e.buffer=this.gl.createBuffer(),this.updateAttribute(e)),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return console.warn("geometry has multiple instanced buffers of different length"),this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor);this.instancedCount=e.count*e.divisor}else"index"===t?this.drawRange.count=e.count:this.attributes.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}updateAttribute(t){this.glState.boundBuffer!==t.buffer&&(this.gl.bindBuffer(t.target,t.buffer),this.glState.boundBuffer=t.buffer),this.gl.bufferData(t.target,t.data,this.gl.STATIC_DRAW),t.needsUpdate=!1}setIndex(t){this.addAttribute("index",t)}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){this.VAOs[t.attributeOrder]=this.gl.renderer.createVertexArray(),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach(((t,{name:e,type:r})=>{if(!this.attributes[e])return void console.warn(`active attribute ${e} not being supplied`);const i=this.attributes[e];this.gl.bindBuffer(i.target,i.buffer),this.glState.boundBuffer=i.buffer;let s=1;35674===r&&(s=2),35675===r&&(s=3),35676===r&&(s=4);const a=i.size/s,n=1===s?0:s*s*s,o=1===s?0:s*s;for(let e=0;e<s;e++)this.gl.vertexAttribPointer(t+e,a,i.type,i.normalized,i.stride+n,i.offset+e*o),this.gl.enableVertexAttribArray(t+e),this.gl.renderer.vertexAttribDivisor(t+e,i.divisor)})),this.attributes.index&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.attributes.index.buffer)}draw({program:t,mode:e=this.gl.TRIANGLES}){this.gl.renderer.currentGeometry!==`${this.id}_${t.attributeOrder}`&&(this.VAOs[t.attributeOrder]||this.createVAO(t),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.gl.renderer.currentGeometry=`${this.id}_${t.attributeOrder}`),t.attributeLocations.forEach(((t,{name:e})=>{const r=this.attributes[e];r.needsUpdate&&this.updateAttribute(r)})),this.isInstanced?this.attributes.index?this.gl.renderer.drawElementsInstanced(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+2*this.drawRange.start,this.instancedCount):this.gl.renderer.drawArraysInstanced(e,this.drawRange.start,this.drawRange.count,this.instancedCount):this.attributes.index?this.gl.drawElements(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+2*this.drawRange.start):this.gl.drawArrays(e,this.drawRange.start,this.drawRange.count)}getPosition(){const t=this.attributes.position;return t.data?t:S?void 0:(console.warn("No position buffer data found to compute bounds"),S=!0)}computeBoundingBox(t){t||(t=this.getPosition());const e=t.data,r=t.stride?t.stride/e.BYTES_PER_ELEMENT:t.size;this.bounds||(this.bounds={min:new c,max:new c,center:new c,scale:new c,radius:1/0});const i=this.bounds.min,s=this.bounds.max,a=this.bounds.center,n=this.bounds.scale;i.set(1/0),s.set(-1/0);for(let t=0,a=e.length;t<a;t+=r){const r=e[t],a=e[t+1],n=e[t+2];i.x=Math.min(r,i.x),i.y=Math.min(a,i.y),i.z=Math.min(n,i.z),s.x=Math.max(r,s.x),s.y=Math.max(a,s.y),s.z=Math.max(n,s.z)}n.sub(s,i),a.add(i,s).divide(2)}computeBoundingSphere(t){t||(t=this.getPosition());const e=t.data,r=t.stride?t.stride/e.BYTES_PER_ELEMENT:t.size;this.bounds||this.computeBoundingBox(t);let i=0;for(let t=0,s=e.length;t<s;t+=r)A.fromArray(e,t),i=Math.max(i,this.bounds.center.squaredDistance(A));this.bounds.radius=Math.sqrt(i)}remove(){for(let t in this.VAOs)this.gl.renderer.deleteVertexArray(this.VAOs[t]),delete this.VAOs[t];for(let t in this.attributes)this.gl.deleteBuffer(this.attributes[t].buffer),delete this.attributes[t]}}class F extends P{constructor(t,{radius:e=.5,widthSegments:r=16,heightSegments:i=Math.ceil(.5*r),phiStart:s=0,phiLength:a=2*Math.PI,thetaStart:n=0,thetaLength:o=Math.PI,attributes:h={}}={}){const l=r,u=i,d=s,x=a,g=n,p=o,f=(l+1)*(u+1),m=l*u*6,y=new Float32Array(3*f),T=new Float32Array(3*f),_=new Float32Array(2*f),w=f>65536?new Uint32Array(m):new Uint16Array(m);let E=0,b=0,v=0,A=g+p;const R=[];let M=new c;for(let t=0;t<=u;t++){let r=[],i=t/u;for(let t=0;t<=l;t++,E++){let s=t/l,a=-e*Math.cos(d+s*x)*Math.sin(g+i*p),n=e*Math.cos(g+i*p),o=e*Math.sin(d+s*x)*Math.sin(g+i*p);y[3*E]=a,y[3*E+1]=n,y[3*E+2]=o,M.set(a,n,o).normalize(),T[3*E]=M.x,T[3*E+1]=M.y,T[3*E+2]=M.z,_[2*E]=s,_[2*E+1]=1-i,r.push(b++)}R.push(r)}for(let t=0;t<u;t++)for(let e=0;e<l;e++){let r=R[t][e+1],i=R[t][e],s=R[t+1][e],a=R[t+1][e+1];(0!==t||g>0)&&(w[3*v]=r,w[3*v+1]=i,w[3*v+2]=a,v++),(t!==u-1||A<Math.PI)&&(w[3*v]=i,w[3*v+1]=s,w[3*v+2]=a,v++)}Object.assign(h,{position:{size:3,data:y},normal:{size:3,data:T},uv:{size:2,data:_},index:{data:w}}),super(t,h)}}class L extends P{constructor(t,{width:e=1,height:r=1,widthSegments:i=1,heightSegments:s=1,attributes:a={}}={}){const n=i,o=s,h=(n+1)*(o+1),l=n*o*6,u=new Float32Array(3*h),c=new Float32Array(3*h),d=new Float32Array(2*h),x=l>65536?new Uint32Array(l):new Uint16Array(l);L.buildPlane(u,c,d,x,e,r,0,n,o),Object.assign(a,{position:{size:3,data:u},normal:{size:3,data:c},uv:{size:2,data:d},index:{data:x}}),super(t,a)}static buildPlane(t,e,r,i,s,a,n,o,h,l=0,u=1,c=2,d=1,x=-1,g=0,p=0){const f=g,m=s/o,y=a/h;for(let T=0;T<=h;T++){let _=T*y-a/2;for(let a=0;a<=o;a++,g++){let y=a*m-s/2;if(t[3*g+l]=y*d,t[3*g+u]=_*x,t[3*g+c]=n/2,e[3*g+l]=0,e[3*g+u]=0,e[3*g+c]=n>=0?1:-1,r[2*g]=a/o,r[2*g+1]=1-T/h,T===h||a===o)continue;let w=f+a+T*(o+1),E=f+a+(T+1)*(o+1),b=f+a+(T+1)*(o+1)+1,v=f+a+T*(o+1)+1;i[6*p]=w,i[6*p+1]=E,i[6*p+2]=v,i[6*p+3]=E,i[6*p+4]=b,i[6*p+5]=v,p++}}}}class C extends P{constructor(t,{width:e=1,height:r=1,depth:i=1,widthSegments:s=1,heightSegments:a=1,depthSegments:n=1,attributes:o={}}={}){const h=s,l=a,u=n,c=(h+1)*(l+1)*2+(h+1)*(u+1)*2+(l+1)*(u+1)*2,d=6*(h*l*2+h*u*2+l*u*2),x=new Float32Array(3*c),g=new Float32Array(3*c),p=new Float32Array(2*c),f=c>65536?new Uint32Array(d):new Uint16Array(d);let m=0,y=0;L.buildPlane(x,g,p,f,i,r,e,u,l,2,1,0,-1,-1,m,y),m+=(u+1)*(l+1),y+=u*l,L.buildPlane(x,g,p,f,i,r,-e,u,l,2,1,0,1,-1,m,y),m+=(u+1)*(l+1),y+=u*l,L.buildPlane(x,g,p,f,e,i,r,u,h,0,2,1,1,1,m,y),m+=(h+1)*(u+1),y+=h*u,L.buildPlane(x,g,p,f,e,i,-r,u,h,0,2,1,1,-1,m,y),m+=(h+1)*(u+1),y+=h*u,L.buildPlane(x,g,p,f,e,r,-i,h,l,0,1,2,-1,-1,m,y),m+=(h+1)*(l+1),y+=h*l,L.buildPlane(x,g,p,f,e,r,i,h,l,0,1,2,1,-1,m,y),Object.assign(o,{position:{size:3,data:x},normal:{size:3,data:g},uv:{size:2,data:p},index:{data:f}}),super(t,o)}}class I extends P{constructor(t,{radiusTop:e=.5,radiusBottom:r=.5,height:i=1,radialSegments:s=8,heightSegments:a=1,openEnded:n=!1,thetaStart:o=0,thetaLength:h=2*Math.PI,attributes:l={}}={}){const u=s,d=a,x=o,g=h,p=n?0:r&&e?2:1,f=(u+1)*(d+1+p)+p,m=u*d*6+p*u*3,y=new Float32Array(3*f),T=new Float32Array(3*f),_=new Float32Array(2*f),w=f>65536?new Uint32Array(m):new Uint16Array(m);let E=0,b=0;const v=[];function A(t){let s;const a=!0===t?e:r,n=!0===t?1:-1,o=E;for(y.set([0,.5*i*n,0],3*E),T.set([0,n,0],3*E),_.set([.5,.5],2*E),E++,s=0;s<=u;s++){const t=s/u*g+x,e=Math.cos(t),r=Math.sin(t);y.set([a*r,.5*i*n,a*e],3*E),T.set([0,n,0],3*E),_.set([.5*e+.5,.5*r*n+.5],2*E),E++}for(s=0;s<u;s++){const e=o+s+1;t?w.set([e,e+1,o],3*b):w.set([e+1,e,o],3*b),b++}}!function(){let t,s;const a=new c,n=(r-e)/i;for(s=0;s<=d;s++){const o=[],h=s/d,l=h*(r-e)+e;for(t=0;t<=u;t++){const e=t/u,r=e*g+x,s=Math.sin(r),c=Math.cos(r);y.set([l*s,(.5-h)*i,l*c],3*E),a.set(s,n,c).normalize(),T.set([a.x,a.y,a.z],3*E),_.set([e,1-h],2*E),o.push(E++)}v.push(o)}for(t=0;t<u;t++)for(s=0;s<d;s++){const e=v[s][t],r=v[s+1][t],i=v[s+1][t+1],a=v[s][t+1];w.set([e,r,a,r,i,a],3*b),b+=2}}(),n||(e&&A(!0),r&&A(!1)),Object.assign(l,{position:{size:3,data:y},normal:{size:3,data:T},uv:{size:2,data:_},index:{data:w}}),super(t,l)}}function U(t,e,r){let i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=r[0],x=r[1],g=r[2],p=r[3],f=r[4],m=r[5],y=r[6],T=r[7],_=r[8];return t[0]=d*i+x*n+g*l,t[1]=d*s+x*o+g*u,t[2]=d*a+x*h+g*c,t[3]=p*i+f*n+m*l,t[4]=p*s+f*o+m*u,t[5]=p*a+f*h+m*c,t[6]=y*i+T*n+_*l,t[7]=y*s+T*o+_*u,t[8]=y*a+T*h+_*c,t}class D extends Array{constructor(t=1,e=0,r=0,i=0,s=1,a=0,n=0,o=0,h=1){return super(t,e,r,i,s,a,n,o,h),this}set(t,e,r,i,s,a,n,o,h){return t.length?this.copy(t):(function(t,e,r,i,s,a,n,o,h,l){t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=a,t[5]=n,t[6]=o,t[7]=h,t[8]=l}(this,t,e,r,i,s,a,n,o,h),this)}translate(t,e=this){return function(t,e,r){let i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=r[0],x=r[1];t[0]=i,t[1]=s,t[2]=a,t[3]=n,t[4]=o,t[5]=h,t[6]=d*i+x*n+l,t[7]=d*s+x*o+u,t[8]=d*a+x*h+c}(this,e,t),this}rotate(t,e=this){return function(t,e,r){let i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=Math.sin(r),x=Math.cos(r);t[0]=x*i+d*n,t[1]=x*s+d*o,t[2]=x*a+d*h,t[3]=x*n-d*i,t[4]=x*o-d*s,t[5]=x*h-d*a,t[6]=l,t[7]=u,t[8]=c}(this,e,t),this}scale(t,e=this){return function(t,e,r){let i=r[0],s=r[1];t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]}(this,e,t),this}multiply(t,e){return e?U(this,t,e):U(this,this,t),this}identity(){var t;return(t=this)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}copy(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}fromMatrix4(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],this}fromQuaternion(t){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=r+r,o=i+i,h=s+s,l=r*n,u=i*n,c=i*o,d=s*n,x=s*o,g=s*h,p=a*n,f=a*o,m=a*h;t[0]=1-c-g,t[3]=u-m,t[6]=d+f,t[1]=u+m,t[4]=1-l-g,t[7]=x-p,t[2]=d-f,t[5]=x+p,t[8]=1-l-c}(this,t),this}fromBasis(t,e,r){return this.set(t[0],t[1],t[2],e[0],e[1],e[2],r[0],r[1],r[2]),this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=u*n-o*l,d=-u*a+o*h,x=l*a-n*h,g=r*c+i*d+s*x;g&&(g=1/g,t[0]=c*g,t[1]=(-u*i+s*l)*g,t[2]=(o*i-s*n)*g,t[3]=d*g,t[4]=(u*r-s*h)*g,t[5]=(-o*r+s*a)*g,t[6]=x*g,t[7]=(-l*r+i*h)*g,t[8]=(n*r-i*a)*g)}(this,t),this}getNormalMatrix(t){return function(t,e){let r=e[0],i=e[1],s=e[2],a=e[3],n=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=e[9],d=e[10],x=e[11],g=e[12],p=e[13],f=e[14],m=e[15],y=r*o-i*n,T=r*h-s*n,_=r*l-a*n,w=i*h-s*o,E=i*l-a*o,b=s*l-a*h,v=u*p-c*g,A=u*f-d*g,R=u*m-x*g,M=c*f-d*p,S=c*m-x*p,P=d*m-x*f,F=y*P-T*S+_*M+w*R-E*A+b*v;F&&(F=1/F,t[0]=(o*P-h*S+l*M)*F,t[1]=(h*R-n*P-l*A)*F,t[2]=(n*S-o*R+l*v)*F,t[3]=(s*S-i*P-a*M)*F,t[4]=(r*P-s*R+a*A)*F,t[5]=(i*R-r*S-a*v)*F,t[6]=(p*b-f*E+m*w)*F,t[7]=(f*_-g*b-m*T)*F,t[8]=(g*E-p*_+m*y)*F)}(this,t),this}}let B=0;class N extends _{constructor(t,{geometry:e,program:r,mode:i=t.TRIANGLES,frustumCulled:s=!0,renderOrder:a=0}={}){super(),t.canvas||console.error("gl not passed as first argument to Mesh"),this.gl=t,this.id=B++,this.geometry=e,this.program=r,this.mode=i,this.frustumCulled=s,this.renderOrder=a,this.modelViewMatrix=new m,this.normalMatrix=new D,this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[]}onBeforeRender(t){return this.beforeRenderCallbacks.push(t),this}onAfterRender(t){return this.afterRenderCallbacks.push(t),this}draw({camera:t}={}){this.beforeRenderCallbacks.forEach((e=>e&&e({mesh:this,camera:t}))),t&&(this.program.uniforms.modelMatrix||Object.assign(this.program.uniforms,{modelMatrix:{value:null},viewMatrix:{value:null},modelViewMatrix:{value:null},normalMatrix:{value:null},projectionMatrix:{value:null},cameraPosition:{value:null}}),this.program.uniforms.projectionMatrix.value=t.projectionMatrix,this.program.uniforms.cameraPosition.value=t.worldPosition,this.program.uniforms.viewMatrix.value=t.viewMatrix,this.modelViewMatrix.multiply(t.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix),this.program.uniforms.modelMatrix.value=this.worldMatrix,this.program.uniforms.modelViewMatrix.value=this.modelViewMatrix,this.program.uniforms.normalMatrix.value=this.normalMatrix);let e=this.program.cullFace&&this.worldMatrix.determinant()<0;this.program.use({flipFaces:e}),this.geometry.draw({mode:this.mode,program:this.program}),this.afterRenderCallbacks.forEach((e=>e&&e({mesh:this,camera:t})))}}let O=1;const X={};function V(t,e,r,i){i=i.length?function(t){const e=t.length,r=t[0].length;if(void 0===r)return t;const i=e*r;let s=X[i];s||(X[i]=s=new Float32Array(i));for(let i=0;i<e;i++)s.set(t[i],i*r);return s}(i):i;const s=t.renderer.state.uniformLocations.get(r);if(i.length)if(void 0===s||s.length!==i.length)t.renderer.state.uniformLocations.set(r,i.slice(0));else{if(function(t,e){if(t.length!==e.length)return!1;for(let r=0,i=t.length;r<i;r++)if(t[r]!==e[r])return!1;return!0}(s,i))return;s.set?s.set(i):function(t,e){for(let r=0,i=t.length;r<i;r++)t[r]=e[r]}(s,i),t.renderer.state.uniformLocations.set(r,s)}else{if(s===i)return;t.renderer.state.uniformLocations.set(r,i)}switch(e){case 5126:return i.length?t.uniform1fv(r,i):t.uniform1f(r,i);case 35664:return t.uniform2fv(r,i);case 35665:return t.uniform3fv(r,i);case 35666:return t.uniform4fv(r,i);case 35670:case 5124:case 35678:case 35680:return i.length?t.uniform1iv(r,i):t.uniform1i(r,i);case 35671:case 35667:return t.uniform2iv(r,i);case 35672:case 35668:return t.uniform3iv(r,i);case 35673:case 35669:return t.uniform4iv(r,i);case 35674:return t.uniformMatrix2fv(r,!1,i);case 35675:return t.uniformMatrix3fv(r,!1,i);case 35676:return t.uniformMatrix4fv(r,!1,i)}}function G(t){let e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}let z=0;function W(t){z>100||(console.warn(t),z++,z>100&&console.warn("More than 100 program warnings - stopping logs."))}class j extends class{constructor(t,{vertex:e,fragment:r,uniforms:i={},transparent:s=!1,cullFace:a=t.BACK,frontFace:n=t.CCW,depthTest:o=!0,depthWrite:h=!0,depthFunc:l=t.LESS}={}){t.canvas||console.error("gl not passed as fist argument to Program"),this.gl=t,this.uniforms=i,this.id=O++,e||console.warn("vertex shader not supplied"),r||console.warn("fragment shader not supplied"),this.transparent=s,this.cullFace=a,this.frontFace=n,this.depthTest=o,this.depthWrite=h,this.depthFunc=l,this.blendFunc={},this.blendEquation={},this.transparent&&!this.blendFunc.src&&(this.gl.renderer.premultipliedAlpha?this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA));const u=t.createShader(t.VERTEX_SHADER);t.shaderSource(u,e),t.compileShader(u),""!==t.getShaderInfoLog(u)&&console.warn(`${t.getShaderInfoLog(u)}\nVertex Shader\n${G(e)}`);const c=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(c,r),t.compileShader(c),""!==t.getShaderInfoLog(c)&&console.warn(`${t.getShaderInfoLog(c)}\nFragment Shader\n${G(r)}`),this.program=t.createProgram(),t.attachShader(this.program,u),t.attachShader(this.program,c),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.warn(t.getProgramInfoLog(this.program));t.deleteShader(u),t.deleteShader(c),this.uniformLocations=new Map;let d=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<d;e++){let r=t.getActiveUniform(this.program,e);this.uniformLocations.set(r,t.getUniformLocation(this.program,r.name));const i=r.name.match(/(\w+)/g);r.uniformName=i[0],3===i.length?(r.isStructArray=!0,r.structIndex=Number(i[1]),r.structProperty=i[2]):2===i.length&&isNaN(Number(i[1]))&&(r.isStruct=!0,r.structProperty=i[1])}this.attributeLocations=new Map;const x=[],g=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<g;e++){const r=t.getActiveAttrib(this.program,e),i=t.getAttribLocation(this.program,r.name);x[i]=r.name,this.attributeLocations.set(r,i)}this.attributeOrder=x.join("")}setBlendFunc(t,e,r,i){this.blendFunc.src=t,this.blendFunc.dst=e,this.blendFunc.srcAlpha=r,this.blendFunc.dstAlpha=i,t&&(this.transparent=!0)}setBlendEquation(t,e){this.blendEquation.modeRGB=t,this.blendEquation.modeAlpha=e}applyState(){this.depthTest?this.gl.renderer.enable(this.gl.DEPTH_TEST):this.gl.renderer.disable(this.gl.DEPTH_TEST),this.cullFace?this.gl.renderer.enable(this.gl.CULL_FACE):this.gl.renderer.disable(this.gl.CULL_FACE),this.blendFunc.src?this.gl.renderer.enable(this.gl.BLEND):this.gl.renderer.disable(this.gl.BLEND),this.cullFace&&this.gl.renderer.setCullFace(this.cullFace),this.gl.renderer.setFrontFace(this.frontFace),this.gl.renderer.setDepthMask(this.depthWrite),this.gl.renderer.setDepthFunc(this.depthFunc),this.blendFunc.src&&this.gl.renderer.setBlendFunc(this.blendFunc.src,this.blendFunc.dst,this.blendFunc.srcAlpha,this.blendFunc.dstAlpha),this.gl.renderer.setBlendEquation(this.blendEquation.modeRGB,this.blendEquation.modeAlpha)}use({flipFaces:t=!1}={}){let e=-1;this.gl.renderer.currentProgram===this.id||(this.gl.useProgram(this.program),this.gl.renderer.currentProgram=this.id),this.uniformLocations.forEach(((t,r)=>{let i=r.uniformName,s=this.uniforms[i];if(r.isStruct&&(s=s[r.structProperty],i+=`.${r.structProperty}`),r.isStructArray&&(s=s[r.structIndex][r.structProperty],i+=`[${r.structIndex}].${r.structProperty}`),!s)return W(`Active uniform ${i} has not been supplied`);if(s&&void 0===s.value)return W(`${i} uniform is missing a value parameter`);if(s.value.texture)return e+=1,s.value.update(e),V(this.gl,r.type,t,e);if(s.value.length&&s.value[0].texture){const i=[];return s.value.forEach((t=>{e+=1,t.update(e),i.push(e)})),V(this.gl,r.type,t,i)}V(this.gl,r.type,t,s.value)})),this.applyState(),t&&this.gl.renderer.setFrontFace(this.frontFace===this.gl.CCW?this.gl.CW:this.gl.CCW)}remove(){this.gl.deleteProgram(this.program)}}{constructor(t,e={}){super(t,{vertex:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 projectionMatrix;\n\tuniform mat3 normalMatrix;\n\tvarying vec3 vNormal;\n\tvoid main() {\n\t\tvNormal = normalize(normalMatrix * normal);\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}\n",fragment:"\n\tprecision highp float;\n\tuniform vec3 uColor;\n\n\tvarying vec3 vNormal;\n\n\tvoid main() {\n\t\tvec3 normal = normalize(vNormal);\n\t\tfloat lighting = dot(normal, normalize(vec3(-0.3, 0.8, 0.6)));\n\t\tgl_FragColor.rgb = uColor + lighting * 0.1;\n\t\tgl_FragColor.a = 1.0;\n\t}\n",transparent:!0,cullFace:null,uniforms:e})}static create(t,e={}){return this.instance?this.instance:this.instance=new j(t,e)}}class q{constructor(t,{program:e,uniforms:r={}}={}){this.uniforms=r,this.program=e||j.create(t,this.uniforms)}use(t){const e=this.program.uniforms;this.program.uniforms=this.uniforms,this.program.use(t),this.program.uniforms=e}get attributeLocations(){return this.program.attributeLocations}}const H=new Uint8Array(4);function Y(t){return 0==(t&t-1)}let k=1;function Z(t=256,e=256,r=4){const i=document.createElement("canvas");i.width=t,i.height=e;const s=i.getContext("2d");s.fillStyle="black";const a=t/r|0,n=e/r|0;for(let t=0;t<r*r;t+=2){const e=t/r|0,i=t%r+e%2;s.fillRect(i*a,e*n,a,n)}return s.lineWidth=4,s.strokeStyle="red",s.setLineDash([5,15]),s.strokeRect(0,0,t,e),s.fill(),i}class Q extends class{constructor(t,{image:e,target:r=t.TEXTURE_2D,type:i=t.UNSIGNED_BYTE,format:s=t.RGBA,internalFormat:a=s,wrapS:n=t.CLAMP_TO_EDGE,wrapT:o=t.CLAMP_TO_EDGE,generateMipmaps:h=!0,minFilter:l=(h?t.NEAREST_MIPMAP_LINEAR:t.LINEAR),magFilter:u=t.LINEAR,premultiplyAlpha:c=!1,unpackAlignment:d=4,flipY:x=r==t.TEXTURE_2D,anisotropy:g=0,level:p=0,width:f,height:m=f}={}){this.gl=t,this.id=k++,this.image=e,this.target=r,this.type=i,this.format=s,this.internalFormat=a,this.minFilter=l,this.magFilter=u,this.wrapS=n,this.wrapT=o,this.generateMipmaps=h,this.premultiplyAlpha=c,this.unpackAlignment=d,this.flipY=x,this.anisotropy=Math.min(g,this.gl.renderer.parameters.maxAnisotropy),this.level=p,this.width=f,this.height=m,this.texture=this.gl.createTexture(),this.store={image:null},this.glState=this.gl.renderer.state,this.state={},this.state.minFilter=this.gl.NEAREST_MIPMAP_LINEAR,this.state.magFilter=this.gl.LINEAR,this.state.wrapS=this.gl.REPEAT,this.state.wrapT=this.gl.REPEAT,this.state.anisotropy=0}bind(){this.glState.textureUnits[this.glState.activeTextureUnit]!==this.id&&(this.gl.bindTexture(this.target,this.texture),this.glState.textureUnits[this.glState.activeTextureUnit]=this.id)}update(t=0){const e=!(this.image===this.store.image&&!this.needsUpdate);if((e||this.glState.textureUnits[t]!==this.id)&&(this.gl.renderer.activeTexture(t),this.bind()),e){if(this.needsUpdate=!1,this.flipY!==this.glState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.glState.flipY=this.flipY),this.premultiplyAlpha!==this.glState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.glState.premultiplyAlpha=this.premultiplyAlpha),this.unpackAlignment!==this.glState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.unpackAlignment),this.glState.unpackAlignment=this.unpackAlignment),this.minFilter!==this.state.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.minFilter),this.state.minFilter=this.minFilter),this.magFilter!==this.state.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.magFilter),this.state.magFilter=this.magFilter),this.wrapS!==this.state.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.wrapS),this.state.wrapS=this.wrapS),this.wrapT!==this.state.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.wrapT),this.state.wrapT=this.wrapT),this.anisotropy&&this.anisotropy!==this.state.anisotropy&&(this.gl.texParameterf(this.target,this.gl.renderer.getExtension("EXT_texture_filter_anisotropic").TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropy),this.state.anisotropy=this.anisotropy),this.image){if(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.level,this.internalFormat,this.format,this.type,this.image[t]);else if(ArrayBuffer.isView(this.image))this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,this.image);else if(this.image.isCompressedTexture)for(let t=0;t<this.image.length;t++)this.gl.compressedTexImage2D(this.target,t,this.internalFormat,this.image[t].width,this.image[t].height,0,this.image[t].data);else this.gl.texImage2D(this.target,this.level,this.internalFormat,this.format,this.type,this.image);this.generateMipmaps&&(this.gl.renderer.isWebgl2||Y(this.image.width)&&Y(this.image.height)?this.gl.generateMipmap(this.target):(this.generateMipmaps=!1,this.wrapS=this.wrapT=this.gl.CLAMP_TO_EDGE,this.minFilter=this.gl.LINEAR)),this.onUpdate&&this.onUpdate()}else if(this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,H);else this.width?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,H);this.store.image=this.image}}}{constructor(t,{width:e=256,height:r=256,count:i=4}={}){super(t,{image:Z(e,r,i)})}}const $=new c;let K=1;var J,tt;!function(t){t.texture="texture",t["texture-array"]="texture-array"}(J||(J={})),function(t){t.default="default",t.mono="mono",t.stereo="stereo",t["stereo-left-right"]="stereo-left-right",t["stereo-top-bottom"]="stereo-top-bottom"}(tt||(tt={}));const et=t=>t&&"function"==typeof t.getOffsetReferenceSpace,rt=()=>void 0!==t.g?t.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};class it{constructor(){this._hasRunDeferredInitialize=!1,this._media=null}initialize(t,e){this.session=t,e&&(this.context=e),this.blendTextureSourceAlpha=!0,this.chromaticAberrationCorrection=!1}destroy(){this._colorTextures=[],this._depthStencilTextures=[]}addEventListener(t,e,r){}dispatchEvent(t){return!1}removeEventListener(t,e,r){}getContext(){return this.context}getTextureType(){throw new Error("Unimplemented")}get colorTextures(){return this._colorTextures}get depthStencilTextures(){return this._depthStencilTextures}get colorTexturesMeta(){return this._texturesMeta}get media(){return this.isMediaLayer()||console.warn("Attempted to retrieve media from a non-media layer"),this._media}determineLayoutAttribute(t,e,r){if(!(e instanceof WebGL2RenderingContext)&&t===J["texture-array"])throw new TypeError;if(r===tt.mono)return r;if(r===tt.default){if(this.session.internalViews&&1===this.session.internalViews.length)return tt.mono;if(t===J["texture-array"])return r}return r===tt.default||r===tt.stereo?tt["stereo-left-right"]:r}isMediaLayer(){return null!==this._media}_deferredInitialize(){}initializeIfNeeded(){this._hasRunDeferredInitialize||(this._hasRunDeferredInitialize=!0,this._deferredInitialize())}_allocateColorTexturesInternal(t,e){let r=this.session.internalViews;if(r&&0!==r.length){if(this.initializeIfNeeded(),this.layout===tt.mono){if(t===J["texture-array"]){const r=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat);return this._texturesMeta=[r],void(this._colorTextures=[r.texture])}{const r=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat);return this._texturesMeta=[r],void(this._colorTextures=[r.texture])}}if(this.layout===tt.stereo){if(t===J["texture-array"]){const r=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat,2);return this._texturesMeta=[r],void(this._colorTextures=[r.texture])}{const r=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat),i=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat);return this._texturesMeta=[r,i],void(this._colorTextures=[r.texture,i.texture])}}if(this.layout===tt["stereo-left-right"]){const r=this._createNewColorTexture(2*e.viewPixelWidth,e.viewPixelHeight,t,e.colorFormat);return this._texturesMeta=[r],void(this._colorTextures=[r.texture])}if(this.layout===tt["stereo-top-bottom"]){const r=this._createNewColorTexture(e.viewPixelWidth,2*e.viewPixelHeight,t,e.colorFormat);return this._texturesMeta=[r],void(this._colorTextures=[r.texture])}}else console.warn("We can't allocate color textures without views")}_allocateDepthStencilTexturesInternal(t,e){if(e.depthFormat){if(this._getSupportedDepthFormats().indexOf(e.depthFormat)<0)throw new Error("Depth format provided is not supported in non-projection layers.");if(e.mipLevels<1)throw new Error("Invalid miplevel. Miplevel needs to be >= 1");if(this.layout===tt.mono){if(t===J["texture-array"]){const r=this._createNewDepthStencilTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat);return void(this._depthStencilTextures=[r.texture])}{const r=this._createNewColorTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat);return void(this._depthStencilTextures=[r.texture])}}if(this.layout===tt.stereo){if(t===J["texture-array"]){const r=this._createNewDepthStencilTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat,2);return void(this._depthStencilTextures=[r.texture])}{const r=this._createNewDepthStencilTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat),i=this._createNewDepthStencilTexture(e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat);return void(this._depthStencilTextures=[r.texture,i.texture])}}if(this.layout!==tt["stereo-left-right"])if(this.layout!==tt["stereo-top-bottom"]);else{const r=this._createNewDepthStencilTexture(e.viewPixelWidth,2*e.viewPixelHeight,t,e.depthFormat);this._depthStencilTextures=[r.texture]}else{const r=this._createNewDepthStencilTexture(2*e.viewPixelWidth,e.viewPixelHeight,t,e.depthFormat);this._depthStencilTextures=[r.texture]}}else this._depthStencilTextures=[]}_createNewColorTexture(t,e,r,i,s=1){return this._createGenericPolyfillTexture(r,t,e,i,0,s)}_createNewDepthStencilTexture(t,e,r,i,s=1){return this._createGenericPolyfillTexture(r,t,e,i,0,s)}_createGenericPolyfillTexture(t,e,r,i,s=0,a=1){if(t===J["texture-array"]&&a<=1&&console.warn("creating a texture array with a single layer..."),t===J["texture-array"]&&this.context instanceof WebGLRenderingContext)throw new Error("WebGL 1 does not support texture array");let n=this.context.createTexture(),o={width:e,height:r,layers:a,type:t,textureFormat:i,texture:n},h=i;this.context instanceof WebGL2RenderingContext&&(h===this.context.DEPTH_COMPONENT&&(h=this.context.DEPTH_COMPONENT24),h===this.context.DEPTH_STENCIL&&(h=this.context.DEPTH24_STENCIL8));let l=this.context.UNSIGNED_BYTE;if(i===this.context.DEPTH_COMPONENT&&(l=this.context.UNSIGNED_INT),this.context instanceof WebGL2RenderingContext?(i===this.context.DEPTH_COMPONENT24&&(l=this.context.UNSIGNED_INT),i!==this.context.DEPTH24_STENCIL8&&i!==this.context.DEPTH_STENCIL||(l=this.context.UNSIGNED_INT_24_8)):i===this.context.DEPTH_STENCIL&&(l=this.context.UNSIGNED_INT_24_8_WEBGL),t===J["texture-array"]&&this.context instanceof WebGL2RenderingContext){console.warn("texture-array layers are supported...questionably in the polyfill at the moment. Use at your own risk.");const t=this.context.getParameter(this.context.TEXTURE_BINDING_2D_ARRAY);this.context.bindTexture(this.context.TEXTURE_2D_ARRAY,n),this._getSupportedDepthFormats().indexOf(i)>=0?this.context.texStorage3D(this.context.TEXTURE_2D_ARRAY,1,h,e,r,a):this.context.texImage3D(this.context.TEXTURE_2D_ARRAY,0,h,e,r,a,0,i,l,null),this.context.bindTexture(this.context.TEXTURE_2D_ARRAY,t)}else{const t=this.context.getParameter(this.context.TEXTURE_BINDING_2D);this.context.bindTexture(this.context.TEXTURE_2D,n),this.context.texImage2D(this.context.TEXTURE_2D,0,h,e,r,0,i,l,null),this.context.bindTexture(this.context.TEXTURE_2D,t)}return o}_getSupportedDepthFormats(){const t=[];return this.context instanceof WebGLRenderingContext&&!this.context.getExtension("WEBGL_depth_texture")||(t.push(this.context.DEPTH_COMPONENT,this.context.DEPTH_STENCIL),this.context instanceof WebGL2RenderingContext&&t.push(this.context.DEPTH_COMPONENT24,this.context.DEPTH24_STENCIL8)),t}}const st={colorFormat:6408,mipLevels:1,layout:tt.mono,isStatic:!1,space:null,viewPixelHeight:0,viewPixelWidth:0,textureType:J.texture,radius:2,centralAngle:.78539,aspectRatio:2},at={layout:tt.mono,invertStereo:!1,space:null,radius:2,centralAngle:.78539};class nt extends it{constructor(t,e){super(),this._media=null!=e?e:null,this.isMediaLayer()?this.init=Object.assign(Object.assign({},at),t):this.init=Object.assign(Object.assign({},st),t),this.radius=this.init.radius,this.centralAngle=this.init.centralAngle,this.aspectRatio=this.init.aspectRatio,this.space=this.init.space,this.layout=this.init.layout;const r=rt();this.init.transform?this.transform=new r.XRRigidTransform(t.transform.position,t.transform.orientation):this.transform=new r.XRRigidTransform({x:0,y:0,z:0,w:1}),this.isMediaLayer()||(this.isStatic=t.isStatic)}getTextureType(){return this.isMediaLayer()?J.texture:this.init.textureType}_deferredInitialize(){let t=this.determineLayoutAttribute(this.init.textureType,this.context,this.init.layout);this.layout=t,this.needsRedraw=!0}get colorTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._colorTextures}get depthStencilTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._depthStencilTextures&&this._depthStencilTextures.length||this._allocateDepthStencilTexturesInternal(this.getTextureType(),this.init),this._depthStencilTextures}get colorTexturesMeta(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._texturesMeta}get width(){return 2*this.radius*Math.PI*(this.centralAngle/(2*Math.PI))}get height(){return this.width/this.aspectRatio}}const ot={colorFormat:6408,mipLevels:1,layout:tt.mono,isStatic:!1,space:null,viewPixelHeight:0,viewPixelWidth:0,textureType:J.texture,radius:0,centralHorizontalAngle:6.28318,upperVerticalAngle:1.570795,lowerVerticalAngle:-1.570795},ht={space:null,layout:tt.mono,invertStereo:!1,radius:0,centralHorizontalAngle:6.28318,upperVerticalAngle:1.570795,lowerVerticalAngle:-1.570795};class lt extends it{constructor(t,e){if(super(),this._media=null!=e?e:null,this.isMediaLayer()?this.init=Object.assign(Object.assign({},ht),t):this.init=Object.assign(Object.assign({},ot),t),!et(this.init.space))throw new TypeError("Equirect layer's space needs to be an XRReferenceSpace");this.radius=this.init.radius,this.centralHorizontalAngle=this.init.centralHorizontalAngle,this.upperVerticalAngle=this.init.upperVerticalAngle,this.lowerVerticalAngle=this.init.lowerVerticalAngle,this.space=this.init.space,this.layout=this.init.layout;const r=rt();t.transform?this.transform=new r.XRRigidTransform(t.transform.position,t.transform.orientation):this.transform=new r.XRRigidTransform({x:0,y:0,z:0,w:1}),this.isMediaLayer()||(this.isStatic=t.isStatic)}getTextureType(){return this.isMediaLayer()?J.texture:this.init.textureType}_deferredInitialize(){let t=this.determineLayoutAttribute(this.init.textureType,this.context,this.init.layout);this.layout=t,this.needsRedraw=!0}get colorTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._colorTextures}get depthStencilTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._depthStencilTextures&&this._depthStencilTextures.length||this._allocateDepthStencilTexturesInternal(this.getTextureType(),this.init),this._depthStencilTextures}get colorTexturesMeta(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._texturesMeta}}const ut={colorFormat:6408,mipLevels:1,layout:tt.mono,isStatic:!1,space:null,viewPixelHeight:0,viewPixelWidth:0,textureType:J.texture,width:1,height:1},ct={space:null,layout:tt.mono,invertStereo:!1};class dt extends it{constructor(t,e){super(),this._media=null!=e?e:null,this.isMediaLayer()?this.init=Object.assign(Object.assign({},ct),t):this.init=Object.assign(Object.assign({},ut),t),this.width=this.init.width,this.height=this.init.height,this.space=this.init.space,this.layout=this.init.layout;const r=rt();this.init.transform?this.transform=new r.XRRigidTransform(t.transform.position,t.transform.orientation):this.transform=new r.XRRigidTransform({x:0,y:0,z:0,w:1}),this.isMediaLayer()||(this.isStatic=t.isStatic)}getTextureType(){return this.isMediaLayer()?J.texture:this.init.textureType}_deferredInitialize(){let t=this.determineLayoutAttribute(this.init.textureType,this.context,this.init.layout);this.layout=t,this.needsRedraw=!0}get colorTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._colorTextures}get depthStencilTextures(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._depthStencilTextures&&this._depthStencilTextures.length||this._allocateDepthStencilTexturesInternal(this.getTextureType(),this.init),this._depthStencilTextures}get colorTexturesMeta(){if(this.isMediaLayer())throw new Error("Media layers do not have associated textures");return this._colorTextures&&this._colorTextures.length||this._allocateColorTexturesInternal(this.getTextureType(),this.init),this._texturesMeta}}class xt{constructor(t){if(this.session=t,this.session.ended)throw new Error("Session has ended")}createQuadLayer(t,e){if(this.session.ended)throw new Error("Session has ended");if(e.layout===tt.default)throw new TypeError("Media Quad layer cannot be created with layout of default");let r=this.calculateAspectRatio(t,e.layout);void 0===e.width&&void 0===e.height&&(e.width=1),void 0===e.height&&(e.height=e.width/r),void 0===e.width&&(e.width=e.height/r);let i=new dt(e,t);return i.needsRedraw=!1,i.initialize(this.session),i}createCylinderLayer(t,e){if(this.session.ended)throw new Error("Session has ended");if(e.layout===tt.default)throw new TypeError("Media Cylinder layer cannot be created with layout of default");let r=this.calculateAspectRatio(t,e.layout);void 0===e.aspectRatio&&(e.aspectRatio=r);let i=new nt(e,t);return i.needsRedraw=!1,i.initialize(this.session),i}createEquirectLayer(t,e){if(this.session.ended)throw new Error("Session has ended");if(e.layout===tt.default)throw new TypeError("Media Equirect layer cannot be created with layout of default");if(!et(e.space))throw new Error("Media Equirect layer's space must be of type XRReferenceSpace");let r=new lt(e,t);return r.needsRedraw=!1,r.initialize(this.session),r}calculateAspectRatio(t,e){let r=t.videoWidth,i=t.videoHeight;return e===tt["stereo-left-right"]&&(r/=2),e===tt["stereo-top-bottom"]&&(i/=2),r/i}}const gt={textureType:J.texture,colorFormat:6408,depthFormat:6402,scaleFactor:1};class pt extends it{constructor(t=gt){super(),this.init=Object.assign(Object.assign({},gt),t)}_allocateProjectionColorTextures(){let t=[],e=[];const r=()=>{t=[];for(let r of e)t.push(r.texture)};let i=this.session,s=i.internalViews;if(!s||0===s.length)return void console.warn("We can't allocate color textures without views");this.initializeIfNeeded();let a=i.getBaseLayer(),n=s.length,o=a.framebufferWidth*this.init.scaleFactor,h=a.framebufferHeight*this.init.scaleFactor;if(this.layout===tt.mono||this.layout===tt.default){if(this.init.textureType===J["texture-array"]){let t=this._createNewColorTexture(o,h,J["texture-array"],this.init.colorFormat,n);e=[t]}else for(let t of s){let t=this._createNewColorTexture(o,h,J.texture,this.init.colorFormat);e.push(t)}return r(),this._colorTexturesMeta=e,void(this._colorTextures=t)}if(this.layout===tt["stereo-left-right"]){let t=this._createNewColorTexture(o*n,h,this.init.textureType,this.init.colorFormat);e=[t]}else if(this.layout===tt["stereo-top-bottom"]){let t=this._createNewColorTexture(o,h*n,this.init.textureType,this.init.colorFormat);e=[t]}r(),this._colorTexturesMeta=e,this._colorTextures=t}_allocateProjectionDepthStencilTextures(){let t=this.session,e=t.internalViews;if(!e||0===e.length)return;if(0===this.init.depthFormat)return void(this._depthStencilTextures=[]);if(this.context instanceof WebGLRenderingContext&&!this.context.getExtension("WEBGL_depth_texture"))return void(this._depthStencilTextures=[]);let r=[],i=[];const s=()=>{r=[];for(let t of i)r.push(t.texture)};this.initializeIfNeeded();let a=t.getBaseLayer(),n=e.length,o=a.framebufferWidth*this.init.scaleFactor,h=a.framebufferHeight*this.init.scaleFactor;if(this.layout===tt.mono||this.layout===tt.default){if(this.init.textureType===J["texture-array"]){let t=this._createNewDepthStencilTexture(o,h,this.init.textureType,this.init.depthFormat,n);i=[t]}else for(let t of e){let t=this._createNewDepthStencilTexture(o,h,this.init.textureType,this.init.depthFormat);i.push(t)}return s(),void(this._depthStencilTextures=r)}if(this.layout===tt["stereo-left-right"]){let t=this._createNewDepthStencilTexture(o*n,h,this.init.textureType,this.init.depthFormat);i=[t]}else if(this.layout===tt["stereo-top-bottom"]){let t=this._createNewDepthStencilTexture(o,h*n,this.init.textureType,this.init.depthFormat);i=[t]}s(),this._depthStencilTextures=r}get colorTextures(){return this._colorTextures&&this._colorTextures.length||this._allocateProjectionColorTextures(),this._colorTextures}get depthStencilTextures(){return void 0===this._depthStencilTextures&&this._allocateProjectionDepthStencilTextures(),this._depthStencilTextures||[]}get colorTexturesMeta(){return this._colorTextures&&this._colorTextures.length||this._allocateProjectionColorTextures(),this._colorTexturesMeta}getTextureType(){return this.init.textureType}_deferredInitialize(){this.isStatic=!1,this.init.depthFormat?this.ignoreDepthValues=!0:this.ignoreDepthValues=!1,this.fixedFoveation=0;let t=this.determineLayoutAttribute(this.init.textureType,this.context,tt.default);this.layout=t,this.needsRedraw=!0;let e=this.determineMaximumScaleFactor(),r=Math.min(this.init.scaleFactor,e);this.init.scaleFactor=r}determineMaximumScaleFactor(){let t=this.session.getBaseLayer(this.context),e=t.framebufferWidth,r=t.framebufferHeight;this.layout===tt["stereo-left-right"]&&(e*=2),this.layout===tt["stereo-top-bottom"]&&(r*=2);let i=Math.max(e,r);return this.context.getParameter(this.context.MAX_TEXTURE_SIZE)/i}}const ft=(t,e,r,i,s)=>{let a=0,n=0,o=e.width,h=e.height;r===tt["stereo-left-right"]?(a=e.width*i/s,o=e.width/s):r===tt["stereo-top-bottom"]&&(n=e.height*i/s,h=e.height/s),t.x=a,t.y=n,t.width=o,t.height=h},mt=(t,e,r)=>{var i=t.createShader(r);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw"could not compile shader:"+t.getShaderInfoLog(i);return i},yt=(t,e,r)=>{const i=t.createProgram(),s=mt(t,e,t.VERTEX_SHADER),a=mt(t,r,t.FRAGMENT_SHADER);if(t.attachShader(i,s),t.attachShader(i,a),t.deleteShader(s),t.deleteShader(a),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw"program failed to link:"+t.getProgramInfoLog(i);return i},Tt=t=>{if(t instanceof WebGL2RenderingContext)return t;const e=t.getExtension("OES_vertex_array_object");if(!e)throw new Error("Cannot use VAOs.");return{bindVertexArray:e.bindVertexArrayOES.bind(e),createVertexArray:e.createVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),isVertexArray:e.isVertexArrayOES.bind(e)}},_t=t=>t,wt=_t`
attribute vec2 a_position;
attribute vec2 a_texCoord;

varying vec2 v_texCoord;

void main() {
   // convert the rectangle from pixels to 0.0 to 1.0
   vec2 zeroToOne = a_position;

   // convert from 0->1 to 0->2
   vec2 zeroToTwo = zeroToOne * 2.0;

   // convert from 0->2 to -1->+1 (clipspace)
   vec2 clipSpace = zeroToTwo - 1.0;

   gl_Position = vec4(clipSpace * vec2(1, 1), 0, 1);

   // pass the texCoord to the fragment shader
   // The GPU will interpolate this value between points.
   v_texCoord = a_texCoord;
}
`,Et=_t`
precision mediump float;

// our texture
uniform sampler2D u_image;

// the texCoords passed in from the vertex shader.
varying vec2 v_texCoord;

void main() {
   	vec4 tex = texture2D(u_image, v_texCoord);
	gl_FragColor = vec4(tex.rgb, tex.a);
}
`;class bt{constructor(t,e){this.gl=e,this.layer=t,this.program=yt(this.gl,wt,Et),this.programInfo={attribLocations:{a_position:this.gl.getAttribLocation(this.program,"a_position"),a_texCoord:this.gl.getAttribLocation(this.program,"a_texCoord")}},this._createVAOs()}render(t){let e=this.gl,r=t.getBaseLayer();e.viewport(0,0,r.framebufferWidth,r.framebufferHeight);const i=this.layer.getTextureType(),s=e.getParameter(e.TEXTURE_BINDING_2D);if(i!==J.texture)throw new Error("Created a texture projection renderer instead of a texture-array projection renderer for a texture-array layer. \nThis is probably an error with the polyfill itself; please file an issue on Github if you run into this.");e.bindTexture(e.TEXTURE_2D,this.layer.colorTextures[0]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let i of t.internalViews){let t=r.getViewport(i);e.viewport(t.x,t.y,t.width,t.height),this._shouldUseStereoTexturePoints()?this._renderInternalStereo(i):this._renderInternal()}e.bindTexture(e.TEXTURE_2D,s)}_renderInternal(){let t=this.gl;const e=t.getParameter(t.CURRENT_PROGRAM);t.useProgram(this.program),this.vaoGl.bindVertexArray(this.vao);var r=t.TRIANGLES;t.drawArrays(r,0,6),this.vaoGl.bindVertexArray(null),t.useProgram(e)}_renderInternalStereo(t){if("none"===t.eye)return this._renderInternal();let e=this.gl;this.vaoGl.bindVertexArray(this.vao);const r=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(this.program),this._setStereoTextureBuffer("right"===t.eye?1:0);var i=e.TRIANGLES;e.drawArrays(i,0,6),this.vaoGl.bindVertexArray(null),e.useProgram(r)}_createVAOs(){this._createTextureUVs();let t=this.gl;this.vaoGl=Tt(t);let e=t.createBuffer();this.vao=this.vaoGl.createVertexArray(),this.vaoGl.bindVertexArray(this.vao),t.enableVertexAttribArray(this.programInfo.attribLocations.a_position),t.bindBuffer(t.ARRAY_BUFFER,e),((t,e,r,i,s)=>{t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.DYNAMIC_DRAW)})(t);let r=t.FLOAT;t.vertexAttribPointer(this.programInfo.attribLocations.a_position,2,r,!1,0,0),this.texcoordBuffer=t.createBuffer(),t.enableVertexAttribArray(this.programInfo.attribLocations.a_texCoord),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer),t.bufferData(t.ARRAY_BUFFER,this.texturePoints,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.programInfo.attribLocations.a_texCoord,2,r,!1,0,0),this.vaoGl.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null)}_setStereoTextureBuffer(t){let e=this.gl;e.enableVertexAttribArray(this.programInfo.attribLocations.a_texCoord),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),e.bufferData(e.ARRAY_BUFFER,this.stereoTexturePoints[t],e.STATIC_DRAW);var r=e.FLOAT;e.vertexAttribPointer(this.programInfo.attribLocations.a_texCoord,2,r,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null)}_createTextureUVs(){this.texturePoints=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);const t={x:0,y:0,width:1,height:1};this._shouldUseStereoTexturePoints()&&(this.stereoTexturePoints=[],ft(t,this.layer.colorTexturesMeta[0],this.layer.layout,0,2),this.stereoTexturePoints[0]=this._offsetTextureUVsByRect(this.layer.colorTexturesMeta[0],this.texturePoints,t),ft(t,this.layer.colorTexturesMeta[0],this.layer.layout,1,2),this.stereoTexturePoints[1]=this._offsetTextureUVsByRect(this.layer.colorTexturesMeta[0],this.texturePoints,t))}_offsetTextureUVsByRect(t,e,r){const i=(r=null!=r?r:{x:0,y:0,width:t.width,height:t.height}).x/t.width,s=r.y/t.height,a=r.width/t.width,n=r.height/t.height,o=[];for(let t=0;t<e.length;t+=2){let r=e[t]*a+i,h=e[t+1]*n+s;o[t]=r,o[t+1]=h}return new Float32Array(o)}_shouldUseStereoTexturePoints(){return this.layer.layout===tt["stereo-left-right"]||this.layer.layout===tt["stereo-top-bottom"]}}const vt=_t`#version 300 es

in vec2 a_position;
in vec2 a_texCoord;

out vec2 v_texCoord;

void main() {
	// convert the rectangle from pixels to 0.0 to 1.0
	vec2 zeroToOne = a_position;

	// convert from 0->1 to 0->2
	vec2 zeroToTwo = zeroToOne * 2.0;
 
	// convert from 0->2 to -1->+1 (clipspace)
	vec2 clipSpace = zeroToTwo - 1.0;
 
	gl_Position = vec4(clipSpace * vec2(1, 1), 0, 1);
 
	// pass the texCoord to the fragment shader
	// The GPU will interpolate this value between points.
	v_texCoord = a_texCoord;
}
`,At=_t`#version 300 es
precision mediump float;
precision mediump int;
precision mediump sampler2DArray;

uniform sampler2DArray u_image;
uniform int u_layer;

in vec2 v_texCoord;

out vec4 fragColor;

void main() {
	vec4 tex = texture(u_image, vec3(v_texCoord.x, v_texCoord.y, u_layer));
 	fragColor = vec4(tex.rgb, tex.a);
}

`;class Rt extends bt{constructor(t,e){super(t,e),this.program=yt(this.gl,vt,At),this._createVAOs(),this.u_layerInfo=this.gl.getUniformLocation(this.program,"u_layer")}render(t){let e=this.gl;if(this.layer.getTextureType()===J.texture)throw new Error("Using texture array projection renderer on a layer without texture array.");let r=t.getBaseLayer();const i=e.getParameter(e.TEXTURE_BINDING_2D_ARRAY);e.bindTexture(e.TEXTURE_2D_ARRAY,this.layer.colorTextures[0]),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR);for(let i of t.internalViews){let s=t.getViewIndex(i),a=r.getViewport(i);e.viewport(a.x,a.y,a.width,a.height),this._renderInternal(s)}e.bindTexture(e.TEXTURE_2D_ARRAY,i)}_renderInternal(t=0){let e=this.gl;const r=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(this.program),e.bindVertexArray(this.vao),e.uniform1i(this.u_layerInfo,t);var i=e.TRIANGLES;e.drawArrays(i,0,6),e.bindVertexArray(null),e.useProgram(r)}}const Mt=(t,e)=>t.getTextureType()===J["texture-array"]&&e instanceof WebGL2RenderingContext?new Rt(t,e):new bt(t,e);var St="undefined"!=typeof Float32Array?Float32Array:Array;function Pt(){var t=new St(16);return St!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Ft(t,e,r){var i=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],x=e[10],g=e[11],p=e[12],f=e[13],m=e[14],y=e[15],T=r[0],_=r[1],w=r[2],E=r[3];return t[0]=T*i+_*o+w*c+E*p,t[1]=T*s+_*h+w*d+E*f,t[2]=T*a+_*l+w*x+E*m,t[3]=T*n+_*u+w*g+E*y,T=r[4],_=r[5],w=r[6],E=r[7],t[4]=T*i+_*o+w*c+E*p,t[5]=T*s+_*h+w*d+E*f,t[6]=T*a+_*l+w*x+E*m,t[7]=T*n+_*u+w*g+E*y,T=r[8],_=r[9],w=r[10],E=r[11],t[8]=T*i+_*o+w*c+E*p,t[9]=T*s+_*h+w*d+E*f,t[10]=T*a+_*l+w*x+E*m,t[11]=T*n+_*u+w*g+E*y,T=r[12],_=r[13],w=r[14],E=r[15],t[12]=T*i+_*o+w*c+E*p,t[13]=T*s+_*h+w*d+E*f,t[14]=T*a+_*l+w*x+E*m,t[15]=T*n+_*u+w*g+E*y,t}function Lt(t,e){var r=e[0],i=e[1],s=e[2],a=e[3],n=r+r,o=i+i,h=s+s,l=r*n,u=i*n,c=i*o,d=s*n,x=s*o,g=s*h,p=a*n,f=a*o,m=a*h;return t[0]=1-c-g,t[1]=u+m,t[2]=d-f,t[3]=0,t[4]=u-m,t[5]=1-l-g,t[6]=x+p,t[7]=0,t[8]=d+f,t[9]=x-p,t[10]=1-l-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ct(){var t=new St(2);return St!=Float32Array&&(t[0]=0,t[1]=0),t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),Ct();const It=t=>t,Ut=It`
attribute vec4 a_position;
attribute vec2 a_texCoord;

uniform mat4 u_matrix;
uniform mat4 u_projectionMatrix;

varying vec2 v_texCoord;

void main() {
  // Multiply the position by the matrix.
  gl_Position = u_projectionMatrix * u_matrix * a_position;

   // pass the texCoord to the fragment shader
   // The GPU will interpolate this value between points.
   v_texCoord = a_texCoord;
}
`,Dt=It`
precision mediump float;

// our texture
uniform sampler2D u_image;

// the texCoords passed in from the vertex shader.
varying vec2 v_texCoord;

void main() {
   	vec4 tex = texture2D(u_image, v_texCoord);
	gl_FragColor = vec4(tex.rgb, tex.a);
	// gl_FragColor = vec4(1.0, 0, 0, 1.0);
}
`,Bt=It`#version 300 es

in vec4 a_position;
in vec2 a_texCoord;

uniform mat4 u_matrix;
uniform mat4 u_projectionMatrix;

out vec2 v_texCoord;

void main() {
	// Multiply the position by the matrix.
    gl_Position = u_projectionMatrix * u_matrix * a_position;
 
	// pass the texCoord to the fragment shader
	// The GPU will interpolate this value between points.
	v_texCoord = a_texCoord;
}
`,Nt=It`#version 300 es
precision mediump float;
precision mediump int;
precision mediump sampler2DArray;

uniform sampler2DArray u_image;
uniform int u_layer;

in vec2 v_texCoord;

out vec4 fragColor;

void main() {
	vec4 tex = texture(u_image, vec3(v_texCoord.x, v_texCoord.y, u_layer));
 	fragColor = vec4(tex.rgb, tex.a);
}

`;class Ot{constructor(t,e){this.usesTextureArrayShaders=!1,this.gl=e,this.layer=t;let r=this.gl;this.transformMatrix=Pt(),e instanceof WebGL2RenderingContext&&this.layer.getTextureType()===J["texture-array"]&&(this.usesTextureArrayShaders=!0),this.usesTextureArrayShaders?this.program=yt(r,Bt,Nt):this.program=yt(r,Ut,Dt),this.programInfo={attribLocations:{a_position:r.getAttribLocation(this.program,"a_position"),a_texCoord:r.getAttribLocation(this.program,"a_texCoord")},uniformLocations:{u_matrix:r.getUniformLocation(this.program,"u_matrix"),u_projectionMatrix:r.getUniformLocation(this.program,"u_projectionMatrix")}},this.usesTextureArrayShaders&&(this.programInfo.uniformLocations.u_layer=r.getUniformLocation(this.program,"u_layer"))}initialize(){let t=this.gl;if(this.layer.isMediaLayer()){this.mediaTexture=t.createTexture(),this.mediaTexturePolyfill={texture:this.mediaTexture,textureFormat:t.RGBA,width:this.layer.media.videoWidth,height:this.layer.media.videoHeight,type:J.texture};const e=t.getParameter(t.TEXTURE_BINDING_2D);t.bindTexture(t.TEXTURE_2D,this.mediaTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.layer.media.videoWidth,this.layer.media.videoHeight,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindTexture(t.TEXTURE_2D,e)}this._createVAOs()}render(t,e){let r=this.gl,i=t.getBaseLayer(),s=e.getViewerPose(t.getReferenceSpace());for(let a of s.views){let s=i.getViewport(a);if(r.viewport(s.x,s.y,s.width,s.height),r.activeTexture(r.TEXTURE0),this.usesTextureArrayShaders){if(r instanceof WebGLRenderingContext)throw new Error("This should never happen; texture-arrays only supported on WebGL2.");if(this.layer.isMediaLayer())throw new Error("This should never happen. Media layers should never be created with texture-array");const i=r.getParameter(r.TEXTURE_BINDING_2D_ARRAY);r.bindTexture(r.TEXTURE_2D_ARRAY,this.layer.colorTextures[0]),r.texParameteri(r.TEXTURE_2D_ARRAY,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D_ARRAY,r.TEXTURE_MIN_FILTER,r.LINEAR);let s=0;this.layer.layout===tt.stereo&&"right"===a.eye&&(s=1),this._shouldUseStereoTexturePoints()?this._renderInternalStereo(t,e,a,s):this._renderInternal(t,e,a,s),r.bindTexture(r.TEXTURE_2D_ARRAY,i)}else{const i=r.getParameter(r.TEXTURE_BINDING_2D);this.layer.isMediaLayer()?(r.bindTexture(r.TEXTURE_2D,this.mediaTexture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.layer.media.videoWidth,this.layer.media.videoHeight,r.RGBA,r.UNSIGNED_BYTE,this.layer.media)):this.layer.layout===tt.stereo&&"right"===a.eye?r.bindTexture(r.TEXTURE_2D,this.layer.colorTextures[1]):r.bindTexture(r.TEXTURE_2D,this.layer.colorTextures[0]),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),this._shouldUseStereoTexturePoints()?this._renderInternalStereo(t,e,a):this._renderInternal(t,e,a),r.bindTexture(r.TEXTURE_2D,i)}}}createPositionPoints(){return new Float32Array([])}createTextureUVs(){return new Float32Array([])}_offsetTextureUVsByRect(t,e,r){const i=(r=null!=r?r:{x:0,y:0,width:t.width,height:t.height}).x/t.width,s=r.y/t.height,a=r.width/t.width,n=r.height/t.height,o=[];for(let t=0;t<e.length;t+=2){let r=e[t]*a+i,h=e[t+1]*n+s;o[t]=r,o[t+1]=h}return new Float32Array(o)}_shouldUseStereoTexturePoints(){return this.layer.layout===tt["stereo-left-right"]||this.layer.layout===tt["stereo-top-bottom"]}_setStereoTextureBuffer(t){let e=this.gl;e.enableVertexAttribArray(this.programInfo.attribLocations.a_texCoord),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),e.bufferData(e.ARRAY_BUFFER,this.stereoTexturePoints[t],e.STATIC_DRAW);var r=e.FLOAT;e.vertexAttribPointer(this.programInfo.attribLocations.a_texCoord,2,r,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null)}_recalculateVertices(){this.positionPoints=this.createPositionPoints(),this.texturePoints=this.createTextureUVs();const t={x:0,y:0,width:1,height:1};if(this._shouldUseStereoTexturePoints()){if(this.stereoTexturePoints=[],this.layer.isMediaLayer())return ft(t,this.mediaTexturePolyfill,this.layer.layout,0,2),this.stereoTexturePoints[0]=this._offsetTextureUVsByRect(this.mediaTexturePolyfill,this.texturePoints,t),ft(t,this.mediaTexturePolyfill,this.layer.layout,1,2),this.stereoTexturePoints[1]=this._offsetTextureUVsByRect(this.mediaTexturePolyfill,this.texturePoints,t),void(this.layer.layout===tt["stereo-top-bottom"]&&([this.stereoTexturePoints[0],this.stereoTexturePoints[1]]=[this.stereoTexturePoints[1],this.stereoTexturePoints[0]]));ft(t,this.layer.colorTexturesMeta[0],this.layer.layout,0,2),this.stereoTexturePoints[0]=this._offsetTextureUVsByRect(this.layer.colorTexturesMeta[0],this.texturePoints,t),ft(t,this.layer.colorTexturesMeta[0],this.layer.layout,1,2),this.stereoTexturePoints[1]=this._offsetTextureUVsByRect(this.layer.colorTexturesMeta[0],this.texturePoints,t),this.layer.layout===tt["stereo-top-bottom"]&&([this.stereoTexturePoints[0],this.stereoTexturePoints[1]]=[this.stereoTexturePoints[1],this.stereoTexturePoints[0]])}}_createVAOs(){this._recalculateVertices();let t=this.gl;this.vaoGl=Tt(t);let e=t.createBuffer();this.vao=this.vaoGl.createVertexArray(),this.vaoGl.bindVertexArray(this.vao),t.enableVertexAttribArray(this.programInfo.attribLocations.a_position),t.bindBuffer(t.ARRAY_BUFFER,e);const r=this.positionPoints;t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);var i=3,s=t.FLOAT,a=!1,n=0,o=0;t.vertexAttribPointer(this.programInfo.attribLocations.a_position,i,s,a,n,o),t.enableVertexAttribArray(this.programInfo.attribLocations.a_texCoord),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer),t.bufferData(t.ARRAY_BUFFER,this.texturePoints,t.STATIC_DRAW),i=2,s=t.FLOAT,a=!1,n=0,o=0,t.vertexAttribPointer(this.programInfo.attribLocations.a_texCoord,i,s,a,n,o),this.vaoGl.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null)}_renderInternal(t,e,r,i){let s=this.gl;const a=s.getParameter(s.CURRENT_PROGRAM);s.useProgram(this.program),this.vaoGl.bindVertexArray(this.vao),this.usesTextureArrayShaders&&s.uniform1i(this.programInfo.uniformLocations.u_layer,i),this._setTransformMatrix(t,e,r),s.uniformMatrix4fv(this.programInfo.uniformLocations.u_matrix,!1,this.transformMatrix),s.uniformMatrix4fv(this.programInfo.uniformLocations.u_projectionMatrix,!1,r.projectionMatrix);var n=s.TRIANGLES,o=this.positionPoints.length/3;s.drawArrays(n,0,o),this.vaoGl.bindVertexArray(null),s.useProgram(a)}_renderInternalStereo(t,e,r,i){if("none"===r.eye)return this._renderInternal(t,e,r);let s=this.gl;this.vaoGl.bindVertexArray(this.vao);const a=s.getParameter(s.CURRENT_PROGRAM);s.useProgram(this.program),this._setStereoTextureBuffer("right"===r.eye?1:0),this.usesTextureArrayShaders&&s.uniform1i(this.programInfo.uniformLocations.u_layer,i),this._setTransformMatrix(t,e,r),s.uniformMatrix4fv(this.programInfo.uniformLocations.u_matrix,!1,this.transformMatrix),s.uniformMatrix4fv(this.programInfo.uniformLocations.u_projectionMatrix,!1,r.projectionMatrix);var n=s.TRIANGLES,o=this.positionPoints.length/3;s.drawArrays(n,0,o),this.vaoGl.bindVertexArray(null),s.useProgram(a)}_setTransformMatrix(t,e,r){let i=e.getPose(this.layer.space,t.getReferenceSpace());Ft(this.transformMatrix,i.transform.matrix,this.layer.transform.matrix),Ft(this.transformMatrix,r.transform.inverse.matrix,this.transformMatrix)}}class Xt extends Ot{constructor(t,e){super(t,e),this.initialize()}createPositionPoints(){const t=this.layer.width,e=this.layer.height;return new Float32Array([-t,-e,0,t,-e,0,-t,e,0,-t,e,0,t,-e,0,t,e,0])}createTextureUVs(){return new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])}}class Vt extends Ot{constructor(t,e){super(t,e),this.segments=16,this.initialize()}createPositionPoints(){const t=[],e=this.layer.centralAngle,r=this.layer.height,i=this.layer.radius,s=e/this.segments,a=Math.PI/2-e/2,n=[],o=Ct();o[0]=i*Math.cos(a),o[1]=-i*Math.sin(a),n.push(o);for(let t=0;t<this.segments;t++){const e=Ct();e[0]=i*Math.cos(a+s*(t+1)),e[1]=-i*Math.sin(a+s*(t+1)),n.push(e)}n.reverse();for(let e=0;e<this.segments;e++){const i=n[e],s=n[e+1];t.push(i[0],-r/2,i[1]),t.push(s[0],-r/2,s[1]),t.push(i[0],r/2,i[1]),t.push(i[0],r/2,i[1]),t.push(s[0],-r/2,s[1]),t.push(s[0],r/2,s[1])}return new Float32Array(t)}createTextureUVs(){let t=[];const e=1/this.segments;for(let r=0;r<this.segments;r++){let i=e*r,s=e*(r+1);t.push(i,0),t.push(s,0),t.push(i,1),t.push(i,1),t.push(s,0),t.push(s,1)}return new Float32Array(t)}}class Gt extends Ot{constructor(t,e){super(t,e),this.segmentsPerAxis=40,this.initialize()}createPositionPoints(){const t=[],e=this.layer.radius||1,r=this.layer.centralHorizontalAngle,i=this.layer.upperVerticalAngle+Math.PI/2,s=this.layer.lowerVerticalAngle+Math.PI/2,a=Math.PI/2-r/2,n=a+r,o=s-i,h=n-a,l=[];for(let t=0;t<=this.segmentsPerAxis;t++)for(let r=0;r<=this.segmentsPerAxis;r++){let s=e,a=n-h*(r/this.segmentsPerAxis),u=o*(t/this.segmentsPerAxis)+i;const c=Math.cos(a)*Math.sin(u),d=Math.cos(u),x=-Math.sin(a)*Math.sin(u);l.push([s*c,s*d,s*x])}const u=this.segmentsPerAxis+1;for(let e=0;e<this.segmentsPerAxis;e++)for(let r=0;r<this.segmentsPerAxis;r++)t.push(...l[r*u+e]),t.push(...l[r*u+e+1]),t.push(...l[(r+1)*u+e]),t.push(...l[(r+1)*u+e]),t.push(...l[r*u+e+1]),t.push(...l[(r+1)*u+e+1]);return new Float32Array(t)}createTextureUVs(){const t=[],e=[];for(let t=0;t<=this.segmentsPerAxis;t++)for(let r=0;r<=this.segmentsPerAxis;r++){const i=r/this.segmentsPerAxis,s=t/this.segmentsPerAxis;e.push([i,s])}const r=this.segmentsPerAxis+1;for(let i=0;i<this.segmentsPerAxis;i++)for(let s=0;s<this.segmentsPerAxis;s++)t.push(...e[s*r+i]),t.push(...e[s*r+i+1]),t.push(...e[(s+1)*r+i]),t.push(...e[(s+1)*r+i]),t.push(...e[s*r+i+1]),t.push(...e[(s+1)*r+i+1]);return new Float32Array(t)}}const zt={colorFormat:6408,mipLevels:1,layout:tt.mono,isStatic:!1,space:null,viewPixelHeight:0,viewPixelWidth:0};class Wt extends it{constructor(t=zt){if(super(),!et(t.space))throw new TypeError("XRCubeLayer's space needs to be an XRReferenceSpace");switch(this.init=Object.assign(Object.assign({},zt),t),this.space=this.init.space,this.isStatic=this.init.isStatic,this.init.orientation?this.orientation=DOMPointReadOnly.fromPoint(this.init.orientation):this.orientation=new DOMPointReadOnly,this.init.layout){case tt.default:case tt["stereo-left-right"]:case tt["stereo-top-bottom"]:throw new TypeError("Invalid layout format for XRCubeLayer")}this.layout=this.init.layout,this.needsRedraw=!0}initialize(t,e){super.initialize(t,e),this._allocateColorTexturesInternal(),this._allocateDepthStencilTexturesInternal()}_allocateColorTexturesInternal(){if(this._colorTextures=[],this._texturesMeta=[],this.layout===tt.mono){const t=this._createCubeColorTexture();return this._texturesMeta.push(t),void this._colorTextures.push(t.texture)}{const t=this._createCubeColorTexture(),e=this._createCubeColorTexture();return this._texturesMeta.push(t,e),void this._colorTextures.push(t.texture,e.texture)}}_allocateDepthStencilTexturesInternal(){if(this._depthStencilTextures=[],this.init.depthFormat){if(this.context instanceof WebGLRenderingContext&&!this.context.getExtension("WEBGL_depth_texture"))throw new TypeError("Depth textures not supported in the current context");if(this.layout!==tt.mono){const t=this._createCubeDepthTexture(),e=this._createCubeDepthTexture();return void this._depthStencilTextures.push(t.texture,e.texture)}{const t=this._createCubeDepthTexture();this._depthStencilTextures.push(t.texture)}}}_createCubeColorTexture(){let t=this.context.createTexture(),e={width:this.init.viewPixelWidth,height:this.init.viewPixelHeight,layers:1,type:J.texture,textureFormat:this.init.colorFormat,texture:t};const r=this.context.getParameter(this.context.TEXTURE_BINDING_CUBE_MAP);this.context.bindTexture(this.context.TEXTURE_CUBE_MAP,t);for(let t=0;t<6;t++)this.context.texImage2D(this.context.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.textureFormat,e.width,e.height,0,e.textureFormat,this.context.UNSIGNED_BYTE,null);return this.context.bindTexture(this.context.TEXTURE_CUBE_MAP,r),e}_createCubeDepthTexture(){let t=this.context.createTexture(),e={width:this.init.viewPixelWidth,height:this.init.viewPixelHeight,layers:1,type:J.texture,textureFormat:this.init.depthFormat,texture:t};const r=this.context.getParameter(this.context.TEXTURE_BINDING_CUBE_MAP);this.context.bindTexture(this.context.TEXTURE_CUBE_MAP,t);let i=this.init.depthFormat;this.context instanceof WebGL2RenderingContext&&(i===this.context.DEPTH_COMPONENT&&(i=this.context.DEPTH_COMPONENT24),i===this.context.DEPTH_STENCIL&&(i=this.context.DEPTH24_STENCIL8));for(let t=0;t<6;t++)this.context.texImage2D(this.context.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,i,e.width,e.height,0,e.textureFormat,this.context.UNSIGNED_INT,null);return this.context.bindTexture(this.context.TEXTURE_CUBE_MAP,r),e}getTextureType(){return J.texture}}const jt=t=>t,qt=jt`
attribute vec4 a_position;
uniform mat4 u_projectionMatrix;
uniform mat4 u_matrix;
varying vec3 v_normal;

void main() {
   gl_Position = u_projectionMatrix * u_matrix * a_position;

   v_normal = normalize(a_position.xyz);
}
`,Ht=jt`
precision mediump float;

varying vec3 v_normal;

uniform samplerCube u_texture;

void main() {
   gl_FragColor = textureCube(u_texture, normalize(v_normal));
}
`;class Yt{constructor(t,e){this.layer=t,this.gl=e,this.transformMatrix=Pt(),this.program=yt(e,qt,Ht),this.programInfo={attribLocations:{a_position:e.getAttribLocation(this.program,"a_position")},uniformLocations:{u_matrix:e.getUniformLocation(this.program,"u_matrix"),u_texture:e.getUniformLocation(this.program,"u_texture"),u_projectionMatrix:e.getUniformLocation(this.program,"u_projectionMatrix")}},this._createVAOs()}render(t,e){let r=this.gl,i=t.getBaseLayer(),s=e.getViewerPose(t.getReferenceSpace());for(let t of s.views){let e=i.getViewport(t);r.viewport(e.x,e.y,e.width,e.height),r.activeTexture(r.TEXTURE0);const s=r.getParameter(r.TEXTURE_BINDING_CUBE_MAP);if(this.layer.layout===tt.stereo){const e="right"===t.eye?1:0;r.bindTexture(r.TEXTURE_CUBE_MAP,this.layer.colorTextures[e])}else r.bindTexture(r.TEXTURE_CUBE_MAP,this.layer.colorTextures[0]);r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,r.LINEAR),this._renderInternal(this.layer.orientation,t),r.bindTexture(r.TEXTURE_CUBE_MAP,s)}}createPositionPoints(){const t=.5;return new Float32Array([-t,-t,-t,-t,t,-t,t,-t,-t,-t,t,-t,t,t,-t,t,-t,-t,-t,-t,t,t,-t,t,-t,t,t,-t,t,t,t,-t,t,t,t,t,-t,t,-t,-t,t,t,t,t,-t,-t,t,t,t,t,t,t,t,-t,-t,-t,-t,t,-t,-t,-t,-t,t,-t,-t,t,t,-t,-t,t,-t,t,-t,-t,-t,-t,-t,t,-t,t,-t,-t,-t,t,-t,t,t,-t,t,-t,t,-t,-t,t,t,-t,t,-t,t,t,-t,t,t,t,-t,t,t,t])}_renderInternal(t,e){let r=this.gl;const i=r.getParameter(r.CURRENT_PROGRAM);r.useProgram(this.program),this.vaoGl.bindVertexArray(this.vao),Lt(this.transformMatrix,[t.x,t.y,t.z,t.w]),this._poseOrientationMatrix||(this._poseOrientationMatrix=Pt()),Lt(this._poseOrientationMatrix,[e.transform.inverse.orientation.x,e.transform.inverse.orientation.y,e.transform.inverse.orientation.z,e.transform.inverse.orientation.w]),Ft(this.transformMatrix,this.transformMatrix,this._poseOrientationMatrix),r.uniformMatrix4fv(this.programInfo.uniformLocations.u_matrix,!1,this.transformMatrix),r.uniformMatrix4fv(this.programInfo.uniformLocations.u_projectionMatrix,!1,e.projectionMatrix),r.uniform1i(this.programInfo.uniformLocations.u_texture,0);var s=r.TRIANGLES,a=this.positionPoints.length/3;r.drawArrays(s,0,a),this.vaoGl.bindVertexArray(null),r.useProgram(i)}_recalculateVertices(){this.positionPoints=this.createPositionPoints()}_createVAOs(){this._recalculateVertices();let t=this.gl;this.vaoGl=Tt(t);let e=t.createBuffer();this.vao=this.vaoGl.createVertexArray(),this.vaoGl.bindVertexArray(this.vao),t.enableVertexAttribArray(this.programInfo.attribLocations.a_position),t.bindBuffer(t.ARRAY_BUFFER,e);const r=this.positionPoints;t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);var i=t.FLOAT;t.vertexAttribPointer(this.programInfo.attribLocations.a_position,3,i,!1,0,0),this.vaoGl.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null)}}class kt{constructor(){this.mode="inline",this.layers=[],this.views=[],this.initializedViews=!1,this.isPolyfillActive=!1,this.taskQueue=[]}requestAnimationFrame(t){this.injectedFrameCallback||(this.injectedFrameCallback=(e,r)=>{let i=this.context;if(!this.initializedViews&&this.referenceSpace){let t=r.getViewerPose(this.referenceSpace);t&&(this.views=t.views,this.initializedViews=!0)}if(this.isPolyfillActive){this.tempFramebuffer||(this.tempFramebuffer=i.createFramebuffer()),i.bindFramebuffer(i.FRAMEBUFFER,this.tempFramebuffer);const t=i.getParameter(i.COLOR_CLEAR_VALUE);i.clearColor(0,0,0,0);for(let t of this.layers)if(t instanceof pt)for(let e=0;e<t.colorTextures.length;e++)t.colorTexturesMeta[e].type===J["texture-array"]||(i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t.colorTextures[e],0),t.depthStencilTextures&&e<t.depthStencilTextures.length?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,t.depthStencilTextures[e],0):i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,null,0),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT));i.bindFramebuffer(i.FRAMEBUFFER,this.getBaseLayer().framebuffer),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.clearColor(t[0],t[1],t[2],t[3])}if(t(e,r),this.isPolyfillActive&&this.initializedViews){let t=i.isEnabled(i.BLEND),e=i.isEnabled(i.DEPTH_TEST),s=i.isEnabled(i.CULL_FACE);i.bindFramebuffer(i.FRAMEBUFFER,this.getBaseLayer().framebuffer),i.enable(i.BLEND),i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE);let a=i.getParameter(i.BLEND_SRC_RGB),n=i.getParameter(i.BLEND_SRC_ALPHA),o=i.getParameter(i.BLEND_DST_RGB),h=i.getParameter(i.BLEND_DST_ALPHA);i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);for(let t of this.layers)if(this.renderers||(this.renderers=new WeakMap),t instanceof pt)this.renderers.has(t)||this.renderers.set(t,Mt(t,this.context)),this.renderers.get(t).render(this);else if(t instanceof dt)this.renderers.has(t)||this.renderers.set(t,new Xt(t,this.context)),this.renderers.get(t).render(this,r);else if(t instanceof nt)this.renderers.has(t)||this.renderers.set(t,new Vt(t,this.context)),this.renderers.get(t).render(this,r);else if(t instanceof lt)this.renderers.has(t)||this.renderers.set(t,new Gt(t,this.context)),this.renderers.get(t).render(this,r);else if(t instanceof Wt)this.renderers.has(t)||this.renderers.set(t,new Yt(t,this.context)),this.renderers.get(t).render(this,r);else{const e=t;if(null===e.framebuffer)continue;i instanceof WebGL2RenderingContext?(i.bindFramebuffer(i.READ_FRAMEBUFFER,e.framebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.getBaseLayer().framebuffer),i.blitFramebuffer(0,0,e.framebufferWidth,e.framebufferHeight,0,0,this.getBaseLayer().framebufferWidth,this.getBaseLayer().framebufferHeight,i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.LINEAR)):console.warn("GL blitFramebuffer is not supported on WebGL1, so XRWebGLLayers may not show up properly when polyfilled.")}for(t||i.disable(i.BLEND),e&&i.enable(i.DEPTH_TEST),s&&i.enable(i.CULL_FACE),i.blendFuncSeparate(a,o,n,h);this.taskQueue.length>0;)this.taskQueue.shift()()}}),this._requestAnimationFrame(this.injectedFrameCallback)}updateRenderState(t){if(this.existingBaseLayer=t.baseLayer,this.layers=t.layers||[],this.activeRenderState||this.createActiveRenderState(),this.activeRenderState=Object.assign(Object.assign({},this.activeRenderState),t),!t.layers)return void this._updateRenderState(t);let e,r=Object.assign({},t);delete r.layers;for(let t of this.layers)if(t instanceof it){e=t.getContext();break}if(!e&&!this.context){console.log("No existing context! Have the session make one");const t=document.createElement("canvas");if(e=t.getContext("webgl2",{xrCompatible:!0}),e||(e=t.getContext("webgl",{xrCompatible:!0})),!e)throw new Error("No webGL support detected.");function r(){e.canvas.width=e.canvas.clientWidth*window.devicePixelRatio,e.canvas.height=e.canvas.clientHeight*window.devicePixelRatio}document.body.appendChild(e.canvas),window.addEventListener("resize",r),r()}this.createInternalLayer(e),this.isPolyfillActive=!0,this._updateRenderState(Object.assign(Object.assign({},r),{baseLayer:this.internalLayer}))}initializeSession(t){this.mode=t,this.requestReferenceSpace("local").then((t=>{this.referenceSpace=t})).catch((t=>{})),this.requestReferenceSpace("viewer").then((t=>{this.viewerSpace=t}))}getBaseLayer(t){return this.internalLayer||this.existingBaseLayer||!t||this.createInternalLayer(t),this.internalLayer||this.existingBaseLayer}getReferenceSpace(){return this.referenceSpace?this.referenceSpace:this.viewerSpace}getViewerSpace(){return this.viewerSpace}queueTask(t){this.taskQueue.push(t)}get renderState(){return this.activeRenderState||this.createActiveRenderState(),this.activeRenderState}get internalViews(){return this.views}getViewIndex(t){for(let e=0;e<this.views.length;e++){let r=this.views[e];if(t.eye===r.eye&&t.recommendedViewportScale===r.recommendedViewportScale)return e}return-1}createInternalLayer(t){if(!t&&this.internalLayer)return this.internalLayer;if(t===this.context&&this.internalLayer)return this.internalLayer;const e=rt();return this.internalLayer=new e.XRWebGLLayer(this,t),this.setContext(t),this.internalLayer}setContext(t){this.context=t,this.tempFramebuffer=t.createFramebuffer(),this.renderers=new WeakMap}createActiveRenderState(){const t=rt();let e=Object.getOwnPropertyNames(t.XRRenderState.prototype);const r={};for(let t of e)r[t]=this._renderState[t];r.layers=[],this.activeRenderState=r}}class Zt{constructor(){this.viewport={x:0,y:0,width:0,height:0}}}class Qt{constructor(t,e){this.session=t,this.context=e,this.subImageCache=new $t}createProjectionLayer(t=gt){const e=new pt(t);if(this.session.ended)throw new Error("Session has ended");if(this.context.isContextLost())throw new Error("context is lost");return e.initialize(this.session,this.context),e}createQuadLayer(t=ut){if(this.session.ended)throw new Error("Session has ended");if(this.context.isContextLost())throw new Error("context is lost");if(t.layout===tt.default)throw new TypeError("Trying to create a quad layer with default layout");const e=new dt(t);return e.initialize(this.session,this.context),e}createCylinderLayer(t=st){if(this.session.ended)throw new Error("Session has ended");if(this.context.isContextLost())throw new Error("context is lost");if(t.layout===tt.default)throw new TypeError("Cylinder Layer cannot have a default layout");const e=new nt(t);return e.initialize(this.session,this.context),e}createEquirectLayer(t=ot){if(this.session.ended)throw new Error("Session has ended");if(this.context.isContextLost())throw new Error("context is lost");if(t.layout===tt.default)throw new TypeError("Equirect Layer cannot have a default layout");if(!et(t.space))throw new TypeError("Equirect layer requires an XRReferenceSpace");let e=new lt(t);return e.initialize(this.session,this.context),e}createCubeLayer(t){if(this.session.ended)throw new Error("Session has ended");if(this.context.isContextLost())throw new Error("context is lost");if(!(this.context instanceof WebGL2RenderingContext))throw new Error("XRCubeLayer only work on WebGL2");if(!et(t.space))throw new TypeError("XRCubeLayer requires a space of type XRReferenceSpace");let e=new Wt(t);return e.initialize(this.session,this.context),e}getSubImage(t,e,r="none"){let i=this.subImageCache.tryGetCachedSubImage(this.context,t,r);if(i)return i;let s=new Zt;if(t instanceof pt)throw new TypeError;if(t.layout===tt.default)throw new TypeError;if(!this.validateStateofSubImageCreation(t,e))throw new Error("Invalid state for subimage creation");let a=0;if(t.layout===tt.stereo){if("none"===r)throw new TypeError;"right"===r&&(a=1)}t.getTextureType()===J["texture-array"]?s.imageIndex=a:s.imageIndex=0;let n=0;t.getTextureType()===J.texture?(s.colorTexture=t.colorTextures[a],n=a):(s.colorTexture=t.colorTextures[0],n=0),t.depthStencilTextures&&t.depthStencilTextures.length?t.getTextureType()===J.texture?s.depthStencilTexture=t.depthStencilTextures[a]:s.depthStencilTexture=t.depthStencilTextures[0]:s.depthStencilTexture=null;const o=t.colorTexturesMeta[n];s.textureWidth=o.width,s.textureHeight=o.height;let h=1;return t.layout!==tt["stereo-left-right"]&&t.layout!==tt["stereo-top-bottom"]||(h=2),ft(s.viewport,o,t.layout,a,h),this.session.queueTask((()=>{t.needsRedraw=!1})),this.subImageCache.cacheSubImage(s,this.context,t,r),s}getViewSubImage(t,e){let r=this.subImageCache.tryGetCachedViewSubImage(this.context,t,e);if(r)return r;let i=new Zt,s=this.session;if(!s.internalViews||!s.internalViews.length)return console.warn("Tried to get view sub image before we have any views"),i;let a=s.getViewIndex(e),n=0;return t.getTextureType()===J["texture-array"]?i.imageIndex=a:i.imageIndex=0,t.layout===tt.default&&t.getTextureType()===J.texture?(i.colorTexture=t.colorTextures[a],n=a):(i.colorTexture=t.colorTextures[0],n=0),0===t.depthStencilTextures.length?i.depthStencilTexture=null:t.layout===tt.default&&t.getTextureType()===J.texture?i.depthStencilTexture=t.depthStencilTextures[a]:i.depthStencilTexture=t.depthStencilTextures[0],i.textureWidth=t.colorTexturesMeta[n].width,i.textureHeight=t.colorTexturesMeta[n].height,ft(i.viewport,t.colorTexturesMeta[n],t.layout,a,s.internalViews.length),t.needsRedraw=!1,this.subImageCache.cacheViewSubImage(i,this.context,t,e),i}validateStateofSubImageCreation(t,e){return!(e.session!==t.session||this.session!==t.session||this.context!==t.context||!t.colorTextures||!t.colorTextures.length||t.isStatic&&!1===t.needsRedraw)}}class $t{constructor(){this.cache=new Map,this.viewCache=new Map}cacheSubImage(t,e,r,i){let s=new Map;s.set(i,t);let a=new Map;a.set(r,s),this.cache.set(e,a)}tryGetCachedSubImage(t,e,r){var i,s;return null===(s=null===(i=this.cache.get(t))||void 0===i?void 0:i.get(e))||void 0===s?void 0:s.get(r)}cacheViewSubImage(t,e,r,i){let s=new Map;s.set(i,t);let a=new Map;a.set(r,s),this.viewCache.set(e,a)}tryGetCachedViewSubImage(t,e,r){var i,s;return null===(s=null===(i=this.viewCache.get(t))||void 0===i?void 0:i.get(e))||void 0===s?void 0:s.get(r)}}class Kt extends N{constructor(t,e={}){super(t,{geometry:new L(t,{width:2*e.width,height:2*e.height}),program:new q(t,{uniforms:{uColor:{value:e.color||[0,1,0]}}})})}}class Jt{constructor(t,e){this.viewport=null,this.context=t,this.target=t.gl.FRAMEBUFFER,this.buffer=e||t.gl.createFramebuffer()}get width(){var t;return this.subImageAttachment?this.subImageAttachment.viewport.width:(null===(t=this.referencedTexture)||void 0===t?void 0:t.width)||0}get height(){var t;return this.subImageAttachment?this.subImageAttachment.viewport.height:(null===(t=this.referencedTexture)||void 0===t?void 0:t.height)||0}get isVirtual(){return!this.subImageAttachment&&!!this.referencedTexture}get texture(){var t,e;return(null===(t=this.subImageAttachment)||void 0===t?void 0:t.colorTexture)||(null===(e=this.referencedTexture)||void 0===e?void 0:e.texture)}get depthTexture(){var t;return null===(t=this.subImageAttachment)||void 0===t?void 0:t.depthStencilTexture}attach(t){if(t===this.subImageAttachment)return;this.subImageAttachment=t,this.context.bindFramebuffer(this);const{gl:e}=this.context;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.colorTexture,0),t.depthStencilTexture&&e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,t.depthStencilTexture,0),this.referencedTexture&&this.copyFrom(this.referencedTexture),this.referencedTexture=null}copyFrom(t){if(!t.texture||t.width*t.width<=0)return;this.subImageAttachment||(this.referencedTexture=t);const{gl:e}=this.context;this.context.bindFramebuffer(this),t.update(),t.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.texture,0),e.bindTexture(e.TEXTURE_2D,this.subImageAttachment.colorTexture),e.copyTexSubImage2D(e.TEXTURE_2D,0,0,0,0,0,this.width,this.height),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.subImageAttachment.colorTexture,0),this.context.bindFramebuffer()}destroy(){this.buffer&&(this.context.gl.deleteFramebuffer(this.buffer),this.subImageAttachment=null,this.target=0,this.viewport=null,this.referencedTexture=null)}}class te extends _{constructor(t,e){super(),this.targets={},this.referencedTexture=null,this.dirty=!1,this.type="none",this.transformDirty=!0,this.options=e,this.context=t,this.onLayerDestroy=()=>{}}get isNative(){return!!this.nativeLayer&&!this.emulatedLayers}_removeFallbackLayers(t){}_createFallbackLayers(){throw new Error("Not implemented")}getRenderTarget(t,e="none"){const r=this.targets[e]||new Jt(this.context);return r.referencedTexture=this.referencedTexture,r.attach(this.context.xr.glBinding.getSubImage(this.nativeLayer,t,e)),this.targets[e]=r,r}bindLayer(t){var e;this.nativeLayer&&this.nativeLayer!==t&&(null===(e=this.onLayerDestroy)||void 0===e||e.call(this,this,!0),this.destroyNative()),t?(this.destroyFallback(),this.nativeLayer=t,this._updateNative(null)):this.createFallback()}_updateNative(t=null){if(this.transformDirty||!this.nativeTransform){const t=new x,e=new c;this.updateMatrixWorld(!1),this.worldMatrix.getRotation(t),this.worldMatrix.getTranslation(e),this.nativeTransform=new self.XRRigidTransform(e,t)}}update(t){this.nativeLayer&&this._updateNative(t)}needUpdateTransform(){this.transformDirty=!0}destroyNative(){this.nativeLayer&&this.nativeLayer.destroy(),this.nativeLayer=null,this.nativeTransform=null}createFallback(){this.emulatedLayers||(this.emulatedLayers=this._createFallbackLayers(),this.emulatedLayers&&this.emulatedLayers.forEach((t=>this.addChild(t))))}destroyFallback(){this.emulatedLayers&&(this._removeFallbackLayers(this.emulatedLayers),this.emulatedLayers.forEach((t=>this.removeChild(t))),this.emulatedLayers=null)}destroy(){var t;null===(t=this.onLayerDestroy)||void 0===t||t.call(this,this,!1),this.destroyNative()}}new class{constructor(){this.injected=!1;const t=rt();this._injectPolyfill(t)}_injectPolyfill(t){if(!("xr"in t.navigator))throw new Error("WebXR Layers polyfill requires WebXR support.");!0===this.injected&&console.warn("Polyfill has already been injected..."),(t=>!!t.navigator.xr&&!(!t.XRMediaBinding||!t.XRWebGLBinding))(t)||(this._polyfillRequiredLayersFeature(t),this._polyfillXRSession(t),t.XRWebGLBinding=Qt,t.XRMediaBinding=xt,this.injected=!0,console.log("Injected Layers Polyfill"))}_polyfillXRSession(t){t.XRSession.prototype._updateRenderState=t.XRSession.prototype.updateRenderState,t.XRSession.prototype._requestAnimationFrame=t.XRSession.prototype.requestAnimationFrame;let e=Object.getOwnPropertyDescriptor(t.XRSession.prototype,"renderState");Object.defineProperty(t.XRSession.prototype,"_renderState",e);let r=Object.getOwnPropertyDescriptor(kt.prototype,"renderState");Object.defineProperty(t.XRSession.prototype,"renderState",r);let i=Object.getOwnPropertyNames(kt.prototype);for(let e of i){let r=Object.getOwnPropertyDescriptor(kt.prototype,e);Object.defineProperty(t.XRSession.prototype,e,r)}}_polyfillRequiredLayersFeature(t){const e=t.navigator.xr.requestSession;Object.defineProperty(t.navigator.xr,"requestSessionInternal",{writable:!0}),t.navigator.xr.requestSessionInternal=e,Object.defineProperty(t.navigator.xr,"requestSession",{writable:!0}),t.navigator.xr.requestSession=(e,r)=>{const i=(r,i)=>t.navigator.xr.requestSessionInternal(r,i).then((t=>{Object.assign(t,new kt);let r=t;return r.initializeSession(e),Promise.resolve(r)}));if("immersive-vr"!==e)return i(e,r);if(!r)return i(e,r);if(r.requiredFeatures&&r.requiredFeatures.indexOf("layers")>-1){const t=Object.assign({},r),s=[...r.requiredFeatures],a=s.indexOf("layers");return s.splice(a,1),t.requiredFeatures=s,i(e,t)}return i(e,r)}}};class ee{constructor(){this.layers=[],this.baseLayer=null,this.lastXRFrame=null}static async requestSession(t,{mode:e="immersive-vr",space:r="local-floor",options:i={requiredFeatures:["local-floor"],optionalFeatures:["layers"]}}={}){const s=new ee;return s.session||(s.session=await navigator.xr.requestSession(e,i)),s.context=t,this.layersSupport=!!s.session.renderState.layers,s.space=await s.session.requestReferenceSpace(r),s}onLayerDestroy(t){ee.layersSupport&&(this.layers=this.layers.filter((e=>e!==t)),this.session.updateRenderState({layers:this.layers}))}getLayer(t,e="base",r={}){if(r=Object.assign({},{space:this.space,viewPixelHeight:100,viewPixelWidth:100},r),!ee.layersSupport&&("base"!==e||this.layers.length>1))return console.warn("[XR] Only single base layer is supported!"),this.baseLayer;let i;if(!this.glBinding&&ee.layersSupport,ee.layersSupport){if(!r)throw new Error("Only base layer can miss options!");switch(this.glBinding=this.glBinding||new self.XRWebGLBinding(this.session,t),e){case"base":i=this.glBinding.createProjectionLayer({}),this.baseLayer=i,this.baseLayerTarget=new Jt(this.context);break;case"quad":i=this.glBinding.createQuadLayer(r);break;default:throw new Error("Unsuppoted yet:"+e)}}else i=new self.XRWebGLLayer(this.session,t),this.baseLayer=i;return this.layers.push(i),ee.layersSupport?this.session.updateRenderState({layers:this.layers}):this.session.updateRenderState({baseLayer:this.baseLayer}),i}requestAnimatioFrame(t){return this.session.requestAnimationFrame(((e,r)=>{this.lastXRFrame=r,t(e,r),this.lastXRFrame=null}))}end(){this.session&&this.session.end()}}ee.layersSupport=!1;class re extends class{constructor({canvas:t=document.createElement("canvas"),width:e=300,height:r=150,dpr:i=1,alpha:s=!1,depth:a=!0,stencil:n=!1,antialias:o=!1,premultipliedAlpha:h=!1,preserveDrawingBuffer:l=!1,powerPreference:u="default",autoClear:c=!0,webgl:d=2}={}){const x={alpha:s,depth:a,stencil:n,antialias:o,premultipliedAlpha:h,preserveDrawingBuffer:l,powerPreference:u};this.dpr=i,this.alpha=s,this.color=!0,this.depth=a,this.stencil=n,this.premultipliedAlpha=h,this.autoClear=c,this.id=K++,2===d&&(this.gl=t.getContext("webgl2",x)),this.isWebgl2=!!this.gl,this.gl||(this.gl=t.getContext("webgl",x)),this.gl||console.error("unable to create webgl context"),this.gl.renderer=this,this.setSize(e,r),this.state={},this.state.blendFunc={src:this.gl.ONE,dst:this.gl.ZERO},this.state.blendEquation={modeRGB:this.gl.FUNC_ADD},this.state.cullFace=null,this.state.frontFace=this.gl.CCW,this.state.depthMask=!0,this.state.depthFunc=this.gl.LESS,this.state.premultiplyAlpha=!1,this.state.flipY=!1,this.state.unpackAlignment=4,this.state.framebuffer=null,this.state.viewport={x:0,y:0,width:null,height:null},this.state.textureUnits=[],this.state.activeTextureUnit=0,this.state.boundBuffer=null,this.state.uniformLocations=new Map,this.extensions={},this.isWebgl2?(this.getExtension("EXT_color_buffer_float"),this.getExtension("OES_texture_float_linear")):(this.getExtension("OES_texture_float"),this.getExtension("OES_texture_float_linear"),this.getExtension("OES_texture_half_float"),this.getExtension("OES_texture_half_float_linear"),this.getExtension("OES_element_index_uint"),this.getExtension("OES_standard_derivatives"),this.getExtension("EXT_sRGB"),this.getExtension("WEBGL_depth_texture"),this.getExtension("WEBGL_draw_buffers")),this.getExtension("WEBGL_compressed_texture_astc"),this.getExtension("EXT_texture_compression_bptc"),this.getExtension("WEBGL_compressed_texture_s3tc"),this.getExtension("WEBGL_compressed_texture_etc1"),this.getExtension("WEBGL_compressed_texture_pvrtc"),this.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),this.drawBuffers=this.getExtension("WEBGL_draw_buffers","drawBuffers","drawBuffersWEBGL"),this.parameters={},this.parameters.maxTextureUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.parameters.maxAnisotropy=this.getExtension("EXT_texture_filter_anisotropic")?this.gl.getParameter(this.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.dpr,this.gl.canvas.height=e*this.dpr,Object.assign(this.gl.canvas.style,{width:t+"px",height:e+"px"})}setViewport(t,e,r=0,i=0){this.state.viewport.width===t&&this.state.viewport.height===e||(this.state.viewport.width=t,this.state.viewport.height=e,this.state.viewport.x=r,this.state.viewport.y=i,this.gl.viewport(r,i,t,e))}setScissor(t,e,r=0,i=0){this.gl.scissor(r,i,t,e)}enable(t){!0!==this.state[t]&&(this.gl.enable(t),this.state[t]=!0)}disable(t){!1!==this.state[t]&&(this.gl.disable(t),this.state[t]=!1)}setBlendFunc(t,e,r,i){this.state.blendFunc.src===t&&this.state.blendFunc.dst===e&&this.state.blendFunc.srcAlpha===r&&this.state.blendFunc.dstAlpha===i||(this.state.blendFunc.src=t,this.state.blendFunc.dst=e,this.state.blendFunc.srcAlpha=r,this.state.blendFunc.dstAlpha=i,void 0!==r?this.gl.blendFuncSeparate(t,e,r,i):this.gl.blendFunc(t,e))}setBlendEquation(t,e){t=t||this.gl.FUNC_ADD,this.state.blendEquation.modeRGB===t&&this.state.blendEquation.modeAlpha===e||(this.state.blendEquation.modeRGB=t,this.state.blendEquation.modeAlpha=e,void 0!==e?this.gl.blendEquationSeparate(t,e):this.gl.blendEquation(t))}setCullFace(t){this.state.cullFace!==t&&(this.state.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.state.frontFace!==t&&(this.state.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.state.depthMask!==t&&(this.state.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.state.depthFunc!==t&&(this.state.depthFunc=t,this.gl.depthFunc(t))}activeTexture(t){this.state.activeTextureUnit!==t&&(this.state.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}bindFramebuffer({target:t=this.gl.FRAMEBUFFER,buffer:e=null}={}){this.state.framebuffer!==e&&(this.state.framebuffer=e,this.gl.bindFramebuffer(t,e))}getExtension(t,e,r){return e&&this.gl[e]?this.gl[e].bind(this.gl):(this.extensions[t]||(this.extensions[t]=this.gl.getExtension(t)),e?this.extensions[t]?this.extensions[t][r].bind(this.extensions[t]):null:this.extensions[t])}sortOpaque(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:t.zDepth!==e.zDepth?t.zDepth-e.zDepth:e.id-t.id}sortTransparent(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.zDepth!==e.zDepth?e.zDepth-t.zDepth:e.id-t.id}sortUI(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:e.id-t.id}getRenderList({scene:t,camera:e,frustumCull:r,sort:i}){let s=[];if(e&&r&&e.updateFrustum(),t.traverse((t=>{if(!t.visible)return!0;t.draw&&(r&&t.frustumCulled&&e&&!e.frustumIntersectsMesh(t)||s.push(t))})),i){const t=[],r=[],i=[];s.forEach((s=>{s.program.transparent?s.program.depthTest?r.push(s):i.push(s):t.push(s),s.zDepth=0,0===s.renderOrder&&s.program.depthTest&&e&&(s.worldMatrix.getTranslation($),$.applyMatrix4(e.projectionViewMatrix),s.zDepth=$.z)})),t.sort(this.sortOpaque),r.sort(this.sortTransparent),i.sort(this.sortUI),s=t.concat(r,i)}return s}render({scene:t,camera:e,target:r=null,update:i=!0,sort:s=!0,frustumCull:a=!0,clear:n}){null===r?(this.bindFramebuffer(),this.setViewport(this.width*this.dpr,this.height*this.dpr)):(this.bindFramebuffer(r),this.setViewport(r.width,r.height)),(n||this.autoClear&&!1!==n)&&(!this.depth||r&&!r.depth||(this.enable(this.gl.DEPTH_TEST),this.setDepthMask(!0)),this.gl.clear((this.color?this.gl.COLOR_BUFFER_BIT:0)|(this.depth?this.gl.DEPTH_BUFFER_BIT:0)|(this.stencil?this.gl.STENCIL_BUFFER_BIT:0))),i&&t.updateMatrixWorld(),e&&e.updateMatrixWorld(),this.getRenderList({scene:t,camera:e,frustumCull:a,sort:s}).forEach((t=>{t.draw({camera:e})}))}}{constructor(t){super(t),this.xr=null,this.layers=[]}createLayer(t="quad",e={}){if(!this.xr)throw new Error("Layers can be requiested ONLY in XR mode");const r=re.layersCtors[t];if(!r)return null;const i=new r(this,e);let s;return this.layers.push(i),ee.layersSupport&&(s=this.xr.getLayer(this.gl,t,e)),i.bindLayer(s),i}onLayerDestroy(t,e){e||(this.layers=this.layers.filter((e=>t!==e))),this.xr&&t.nativeLayer&&this.xr.onLayerDestroy(t.nativeLayer)}onSessionLost(){this.xr=null,console.warn("XR Session end")}async requestXR(t){return this.xr?Promise.resolve():(await this.gl.makeXRCompatible(),this.xr=await ee.requestSession(this,t),this.xr.getLayer(this.gl,"base"),this.xr)}requestAnimatioFrame(t){return this.xr?this.xr.requestAnimatioFrame(t):self.requestAnimationFrame(t)}setViewportUnchecked({width:t,height:e,x:r=0,y:i=0}){this.state.viewport.width=t,this.state.viewport.height=e,this.state.viewport.x=r,this.state.viewport.y=i,this.gl.viewport(r,i,t,e)}renderXR(t){const{xr:e,gl:r}=this;if(!e||!e.lastXRFrame)return;const i=t.camera,{lastXRFrame:s,space:a,baseLayer:n,glBinding:o,baseLayerTarget:h}=e,l=s.getViewerPose(a);l&&(l.views.forEach(((e,s)=>{const{projectionMatrix:a,transform:l}=e,{position:u,orientation:c}=l;let d,x;if(n instanceof self.XRWebGLLayer)x=n.getViewport(e),d={target:r.FRAMEBUFFER,buffer:n.framebuffer,width:x.width,height:x.height};else{const t=o.getViewSubImage(n,e);x=t.viewport,d=h,0===s&&h.attach(t)}i.projectionMatrix.copy(a),i.position.set(u.x,u.y,u.z),i.quaternion.set(c.x,c.y,c.z,c.w),i.updateMatrixWorld(),this.setViewportUnchecked(x),super.render(Object.assign(Object.assign({},t),{camera:i,target:d,clear:0===s&&(null!=t.clear?t.clear:this.autoClear)}))})),this.bindFramebuffer(),this.layers.forEach((t=>{t!==n&&t.update(s)})))}render(t){if(!t.target&&this.xr)return this.renderXR(t);super.render(t)}}re.layersCtors={cube:null,sphere:null,quad:class extends te{constructor(){super(...arguments),this.type="quad"}set width(t){this.nativeLayer.width=t}get width(){return this.nativeLayer.width}set height(t){this.nativeLayer.height=t}get height(){return this.nativeLayer.height}_removeFallbackLayers(t){}_createFallbackLayers(){var t;const e=[new Kt(this.context.gl,this.options)];return(null===(t=this.options.layout)||void 0===t?void 0:t.includes("stereo"))&&e.push(new Kt(this.context.gl,this.options)),e}_updateNative(t=null){var e;if(super._updateNative(t),this.nativeLayer.transform=this.nativeTransform,(this.nativeLayer.needsRedraw||this.dirty)&&t&&this.referencedTexture){if(null===(e=this.options.layout)||void 0===e?void 0:e.includes("stereo"))for(let e of["left","right"])this.getRenderTarget(t,e);else this.getRenderTarget(t,"none");this.dirty=!1}}}};{const t=document.querySelector("#requiest-xr"),e=document.querySelector("#frame"),r=new re({dpr:2,canvas:e,antialias:!0,autoClear:!0}),i=r.gl;i.clearColor(1,1,1,1);const s=new Q(i,{width:1024,height:1024,count:4});document.body.appendChild(s.image);const a=new v(i,{fov:35});function n(){r.setSize(window.innerWidth,window.innerHeight),a.perspective({aspect:i.canvas.width/i.canvas.height})}a.lookAt([0,0,0]),window.addEventListener("resize",n,!1),n(),t.addEventListener("click",(async()=>{await r.requestXR();const t=r.createLayer("quad",{width:2,height:1,viewPixelHeight:s.image.height,viewPixelWidth:s.image.width});t.referencedTexture=s,o.addChild(t),r.xr.requestAnimatioFrame(g)}));const o=new _;o.position.set(0,1,-4);const h=new F(i),l=new C(i),u=new I(i),c=new N(i,{geometry:h,program:new q(i,{uniforms:{uColor:{value:[1,1,0]}}})});c.position.set(1.3,0,0),c.setParent(o);const d=new N(i,{geometry:l,program:new q(i,{uniforms:{uColor:{value:[1,0,0]}}})});d.position.set(0,-1.3,0),d.setParent(o);const x=new N(i,{geometry:u,program:new q(i,{uniforms:{uColor:{value:[0,0,1]}}})});function g(t,e=null){r.requestAnimatioFrame(g),c.rotation.y-=.03,d.rotation.y-=.04,x.rotation.y-=.02,r.gl.clearColor(1,1,1,1),r.render({scene:o,camera:a})}x.position.set(-1.3,0,0),x.setParent(o),r.requestAnimatioFrame(g)}})();